{% extends "base.html" %}

{% block title %}Search Books{% endblock %}

{% block content %}
<!-- Content Type Selector -->
<div class="row mb-3">
    <div class="col-12">
        <div class="content-type-selector btn-group w-100">
            <a href="/books/search" 
               class="btn btn-lg btn-primary" id="books-tab">
                <i class="fas fa-book me-1"></i> Books
            </a>
            <a href="/manga/search" 
               class="btn btn-lg btn-outline-primary" id="manga-tab">
                <i class="fas fa-book-open me-1"></i> Manga
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">Search Books</h5>
    </div>
    <div class="card-body">
        <form id="bookSearchForm" class="mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <input type="text" class="form-control" id="searchQuery" placeholder="Enter book title..." required>
                </div>
                <!-- Title/Author dropdown hidden - Title search only -->
                <!--
                <div class="col-md-2">
                    <select class="form-select" id="searchTypeSelect">
                        <option value="title">Title</option>
                        <option value="author">Author</option>
                    </select>
                </div>
                -->
                <!-- Hidden input to set search type to title by default -->
                <input type="hidden" id="searchTypeSelect" value="title">
                <div class="col-md-4">
                    <select class="form-select" id="searchProvider">
                        <option value="">All Providers</option>
                        <!-- Providers will be populated dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i> Search
                    </button>
                </div>
            </div>
        </form>
        
        <div id="searchResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-5 row-cols-xxl-6 g-4">
            <!-- Search results will be populated here -->
        </div>
        
        <div id="loadingIndicator" class="text-center my-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Searching for books...</p>
        </div>
        
        <div id="noResults" class="text-center my-5 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>No results found</h5>
            <p class="text-muted">Try a different search term or search type</p>
        </div>
    </div>
</div>

<!-- Book Details Modal -->
<div class="modal fade" id="bookDetailsModal" tabindex="-1" aria-labelledby="bookDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookDetailsModalLabel">Book Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <img id="modalCover" src="" alt="Cover Image" class="img-fluid rounded">
                        <div class="mt-3">
                            <div class="mb-2">
                                <label class="form-label small mb-1">Collection</label>
                                <select id="modalCollection" class="form-select form-select-sm">
                                    <!-- Collections will be populated dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small mb-1">Root Folder</label>
                                <select id="modalRootFolder" class="form-select form-select-sm">
                                    <option value="">-- Auto --</option>
                                    <!-- Root folders will be populated dynamically -->
                                </select>
                            </div>
                            <button id="btnAddToCollection" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-plus-circle me-2"></i> Add to Collection
                            </button>
                            <button id="btnWantToRead" class="btn btn-outline-warning w-100">
                                <i class="fas fa-bookmark me-2"></i> Want to Read
                            </button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4 id="modalTitle" class="mb-3"></h4>
                        <div id="modalAltTitles" class="text-muted small mb-3"></div>
                        
                        <!-- Author info will be dynamically populated here -->
                        <div id="modalAuthor" class="mb-4"></div>
                        
                        <!-- Book-specific fields -->
                        <div class="book-fields">
                            <div class="mb-3">
                                <strong>Publisher:</strong> <span id="modalPublisher"></span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Published:</strong> <span id="modalPublishedDate"></span>
                            </div>
                            
                            <div class="mb-3">
                                <strong>ISBN:</strong> <span id="modalISBN"></span>
                            </div>
                        </div>
                        
                        <!-- Genres/Subjects -->
                        <div class="mb-4">
                            <strong>Subjects:</strong>
                            <div id="modalGenres" class="mt-2"></div>
                        </div>
                        
                        <!-- Description/Biography -->
                        <div class="mb-3">
                            <strong>Description:</strong>
                            <div id="modalDescription" class="mt-2 description-box"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <!-- Edit and Delete buttons for authors (hidden by default, shown when viewing author details) -->
                <button type="button" class="btn btn-primary author-action-btn" id="btnEditAuthor" style="display: none;">
                    <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button type="button" class="btn btn-danger author-action-btn" id="btnDeleteAuthor" style="display: none;">
                    <i class="fas fa-trash me-1"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Success Modal -->
<div class="modal fade" id="importSuccessModal" tabindex="-1" aria-labelledby="importSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importSuccessModalLabel">Import Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success fa-4x"></i>
                </div>
                <p id="importSuccessMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="viewBookLink" href="#" class="btn btn-primary">View Book</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Search type is now fixed to 'title' - no need for change listener
        // The #searchTypeSelect is a hidden input with value="title"
        
        // Load providers
        console.log('Loading providers for books search...');
        $.ajax({
            url: '/api/metadata/providers',
            method: 'GET',
            success: function(data) {
                console.log('Providers loaded:', data);
                const providerSelect = $('#searchProvider');
                
                if (data.providers) {
                    // Explicitly define book providers
                    const bookProviders = [
                        'GoogleBooks', 'OpenLibrary', 'Goodreads', 'Amazon', 'LibraryThing',
                        'WorldCat', 'CBRydb'
                    ];
                    
                    // Explicitly define manga providers
                    const mangaProviders = [
                        'MangaDex', 'AniList', 'MyAnimeList', 'Comick', 'MangaUpdates',
                        'MangaFire', 'MangaAPI'
                    ];
                    
                    Object.keys(data.providers).forEach(function(providerName) {
                        const provider = data.providers[providerName];
                        console.log('Provider:', providerName, provider);
                        
                        // Check if this is a book provider
                        let isBookProvider = false;
                        
                        // Exact match for known book providers
                        if (bookProviders.includes(providerName)) {
                            isBookProvider = true;
                        }
                        
                        // Check for book-related keywords in provider name
                        if (providerName.toLowerCase().includes('book') || 
                            providerName.toLowerCase().includes('library') || 
                            providerName.toLowerCase().includes('read')) {
                            isBookProvider = true;
                        }
                        
                        // Exclude explicitly known manga providers
                        if (mangaProviders.includes(providerName) || 
                            providerName.toLowerCase().includes('manga') || 
                            providerName.toLowerCase().includes('anime')) {
                            isBookProvider = false;
                        }
                        
                        if (provider.enabled && isBookProvider) {
                            providerSelect.append(`<option value="${providerName}">${providerName}</option>`);
                        }
                    });
                    console.log('Book providers added to dropdown');
                } else {
                    console.warn('No providers found in response');
                }
            },
            error: function(xhr) {
                console.error('Error loading providers:', xhr.responseText);
                notificationManager.error('Failed to load metadata providers');
            }
        });
        
        // Search form submission
        $('#bookSearchForm').on('submit', function(e) {
            e.preventDefault();
            
            const query = $('#searchQuery').val().trim();
            const provider = $('#searchProvider').val();
            const searchType = $('#searchTypeSelect').val();
            
            console.log('Search query:', query);
            console.log('Search provider:', provider);
            console.log('Search type:', searchType);
            
            if (!query) {
                notificationManager.warning('Please enter a search term');
                return;
            }
            
            // Show loading indicator
            $('#searchResults').empty();
            $('#noResults').addClass('d-none');
            $('#loadingIndicator').removeClass('d-none');
            
            // Build URL based on search type
            let url;
            if (searchType === 'author') {
                // Use dedicated author search API
                url = `/api/metadata/author_search?query=${encodeURIComponent(query)}`;
                if (provider) {
                    url += `&provider=${provider}`;
                }
                console.log('Using dedicated author search API:', url);
            } else {
                // Use regular book search API
                url = `/api/metadata/search?query=${encodeURIComponent(query)}&search_type=${searchType}&content_type=BOOK`;
                if (provider) {
                    url += `&provider=${provider}`;
                }
                console.log('Using book search API:', url);
            }
            
            // Perform search
            $.ajax({
                url: url,
                method: 'GET',
                success: function(data) {
                    $('#loadingIndicator').addClass('d-none');
                    
                    let totalResults = 0;
                    const resultsContainer = $('#searchResults');
                    
                    // Process results from each provider
                    if (data.results) {
                        Object.keys(data.results).forEach(function(providerName) {
                            const providerResults = data.results[providerName];
                            
                            if (providerResults && providerResults.length > 0) {
                                totalResults += providerResults.length;
                                
                                providerResults.forEach(function(book) {
                                    const card = createBookCard(book, providerName);
                                    resultsContainer.append(card);
                                });
                            }
                        });
                    }
                    
                    if (totalResults === 0) {
                        $('#noResults').removeClass('d-none');
                    }
                },
                error: function(xhr) {
                    $('#loadingIndicator').addClass('d-none');
                    console.error('Search error:', xhr.responseText);
                    notificationManager.error('Search failed. Please try again.');
                }
            });
        });
        
        // Create book card
        function createBookCard(book, providerName) {
            const searchType = $('#searchTypeSelect').val();
            
            // Handle author results from dedicated author search API
            if (book.is_author === true) {
                // Process author image URL
                let imageUrl = book.image_url || '/static/img/no-cover.png';
                if (imageUrl && imageUrl.startsWith('http')) {
                    // Use image proxy for external images
                    imageUrl = `/api/proxy/image?url=${encodeURIComponent(imageUrl)}`;
                }
                
                // Ensure the image is loaded properly
                const img = new Image();
                img.onload = function() {
                    // Image loaded successfully
                    console.log('Author image loaded:', imageUrl);
                };
                img.onerror = function() {
                    // If image fails to load, use fallback
                    console.log('Author image failed to load, using fallback');
                    imageUrl = '/static/img/no-cover.png';
                };
                if (imageUrl !== '/static/img/no-cover.png') {
                    img.src = imageUrl;
                }
                
                // Create an author card
                return `
                    <div class="col">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Author</h5>
                            </div>
                            <img src="${imageUrl}" class="card-img-top author-cover" alt="${book.name}" onerror="this.src='/static/img/no-cover.png'">
                            <div class="card-body">
                                <h5 class="card-title text-truncate">${book.name}</h5>
                                <div class="author-info">
                                    ${book.birth_date ? `<p class="mb-1"><strong>Born:</strong> ${book.birth_date}</p>` : ''}
                                    ${book.death_date ? `<p class="mb-1"><strong>Died:</strong> ${book.death_date}</p>` : ''}
                                    ${book.work_count ? `<p class="mb-1"><strong>Works:</strong> ${book.work_count}</p>` : ''}
                                    ${book.top_work ? `<p class="mb-1"><strong>Notable:</strong> ${book.top_work}</p>` : ''}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-info">${providerName}</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm w-100 view-author-details" 
                                        data-author-id="${book.id}" 
                                        data-provider="${providerName}">
                                    <i class="fas fa-info-circle me-1"></i> Author Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } 
            // Special handling for author search results from regular API
            else if (searchType === 'author') {
                // Extract author key from the book ID
                let authorKey = '';
                if (book.id && typeof book.id === 'string') {
                    // For OpenLibrary, try to extract author key from work key
                    if (book.url && book.url.includes('/works/')) {
                        // We need to use the author name to search for the author
                        authorKey = book.author;
                    } else {
                        authorKey = book.id;
                    }
                }
                
                // Process cover URL
                let coverUrl = book.cover_url || '/static/img/no-cover.png';
                if (coverUrl && coverUrl.startsWith('http')) {
                    coverUrl = `/api/proxy/image?url=${encodeURIComponent(coverUrl)}`;
                }
                
                // Create an author-focused card
                return `
                    <div class="col">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Author</h5>
                            </div>
                            <img src="${coverUrl}" class="card-img-top author-cover" alt="${book.author}" onerror="this.src='/static/img/no-cover.png'">
                            <div class="card-body">
                                <h5 class="card-title text-truncate">${book.author}</h5>
                                <p class="card-text">Notable work: ${book.title}</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="badge bg-info">${providerName}</span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm w-100 view-author-details" 
                                        data-author-name="${encodeURIComponent(book.author)}" 
                                        data-provider="${providerName}">
                                    <i class="fas fa-info-circle me-1"></i> Author Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            // Handle regular book results
            else {
                // Process cover URL
                let coverUrl = book.cover_url || '/static/img/no-cover.png';
                if (coverUrl && coverUrl.startsWith('http')) {
                    coverUrl = `/api/proxy/image?url=${encodeURIComponent(coverUrl)}`;
                }
                
                const title = book.title || 'Unknown Title';
                const author = book.author || 'Unknown Author';
                
                // Create a regular book card
                return `
                    <div class="col">
                        <div class="card h-100">
                            <img src="${coverUrl}" class="card-img-top book-cover" alt="${title}" onerror="this.src='/static/img/no-cover.png'">
                            <div class="card-body">
                                <h5 class="card-title text-truncate">${title}</h5>
                                <p class="card-text text-muted">${author}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-info">${providerName}</span>
                                    ${book.rating ? `<span class="badge bg-warning"><i class="fas fa-star me-1"></i> ${book.rating}</span>` : ''}
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary btn-sm w-100 view-details" 
                                        data-book-id="${book.id}" 
                                        data-provider="${providerName}">
                                    <i class="fas fa-info-circle me-1"></i> Book Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Load collections
        function loadCollections() {
            return $.get('/api/collections').then(function(resp) {
                const $sel = $('#modalCollection');
                $sel.empty();
                
                if (resp && resp.success && Array.isArray(resp.collections)) {
                    // Filter for book collections
                    const bookCollections = resp.collections.filter(c => 
                        (c.content_type || '').toUpperCase() === 'BOOK' || 
                        (c.content_type || '').toUpperCase() === 'NOVEL'
                    );
                    
                    // Sort by name
                    bookCollections.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Add options
                    bookCollections.forEach(c => {
                        $sel.append(`<option value="${c.id}">${c.name}${c.is_default? ' (default)':''}</option>`);
                    });
                    
                    // Select default collection
                    const defaultCollection = bookCollections.find(c => c.is_default === 1);
                    if (defaultCollection) {
                        $sel.val(defaultCollection.id);
                    }
                    
                    // Load root folders for selected collection
                    loadRootFoldersForCollection($sel.val());
                }
            });
        }
        
        // Load root folders for collection
        function loadRootFoldersForCollection(collectionId) {
            const $rf = $('#modalRootFolder');
            $rf.prop('disabled', true).empty().append('<option value="">-- Auto --</option>');
            
            if (!collectionId) return;
            
            $.get(`/api/collections/${collectionId}/root-folders`).then(function(resp) {
                const rootFolders = (resp && resp.success && Array.isArray(resp.root_folders)) ? resp.root_folders : [];
                
                if (rootFolders.length > 0) {
                    rootFolders.forEach(r => $rf.append(`<option value="${r.id}">${r.name} (${r.path})</option>`));
                    $rf.prop('disabled', false);
                }
            });
        }
        
        // Collection change event
        $(document).on('change', '#modalCollection', function() {
            loadRootFoldersForCollection($(this).val());
        });
        
        // View author details
        $(document).on('click', '.view-author-details', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            const provider = $(this).data('provider');
            
            // Show a modal with author details
            $('#modalTitle').text('Loading author details...');
            $('#modalCover').attr('src', '/static/img/no-cover.png');
            $('#modalAuthor').html('<div class="text-center my-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading author information...</p></div>');
            $('#modalPublisher').parent().parent().hide(); // Hide publisher row
            $('#modalPublishedDate').parent().parent().hide(); // Hide published date row
            $('#modalISBN').parent().parent().hide(); // Hide ISBN row
            $('#modalGenres').empty();
            $('#modalDescription').html('<div class="text-center"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            
            // Hide author action buttons initially
            $('#btnEditAuthor').hide();
            $('#btnDeleteAuthor').hide();
            
            // Show modal with a different title
            $('#bookDetailsModalLabel').text('Author Details');
            const bookModal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
            bookModal.show();
            
            // Determine which API to use based on available data
            let apiUrl;
            if (authorId) {
                apiUrl = `/api/metadata/author/${provider}/${authorId}`;
            } else if (authorName) {
                // Search for author by name
                apiUrl = `/api/metadata/search?query=${authorName}&search_type=author&content_type=BOOK&provider=${provider}`;
            } else {
                $('#modalDescription').text('Error: No author ID or name provided');
                return;
            }
            
            // Fetch author details
            $.ajax({
                url: apiUrl,
                method: 'GET',
                success: function(data) {
                    // If we searched by name, we need to extract the first result
                    if (authorName) {
                        if (data.results && data.results[provider] && data.results[provider].length > 0) {
                            // Use the first result
                            const authorResult = data.results[provider][0];
                            
                            // Display basic author info
                            $('#modalTitle').text(authorResult.author || 'Unknown Author');
                            
                            // Use image proxy for external images in modal
                            if (authorResult.image_url) {
                                let imageUrl = authorResult.image_url;
                                if (imageUrl.startsWith('http')) {
                                    imageUrl = `/api/proxy/image?url=${encodeURIComponent(imageUrl)}`;
                                }
                                
                                // Preload image to ensure it's valid
                                const img = new Image();
                                img.onload = function() {
                                    // Image loaded successfully, update modal
                                    $('#modalCover').attr('src', imageUrl);
                                    console.log('Author details image loaded successfully:', imageUrl);
                                };
                                img.onerror = function() {
                                    // Image failed to load, use fallback
                                    $('#modalCover').attr('src', '/static/img/no-cover.png');
                                    console.log('Author details image failed to load, using fallback');
                                };
                                img.src = imageUrl;
                            } else {
                                $('#modalCover').attr('src', '/static/img/no-cover.png');
                            }
                            
                            let authorInfoHtml = `<p><strong>Author:</strong> ${authorResult.author}</p>`;
                            if (authorResult.title) {
                                authorInfoHtml += `<p><strong>Notable Work:</strong> ${authorResult.title}</p>`;
                            }
                            
                            $('#modalAuthor').html(authorInfoHtml);
                            $('#modalDescription').text('Author information is limited when searching by name. Try using the OpenLibrary website for more details.');
                            
                            return;
                        } else {
                            $('#modalDescription').text('No author details found');
                            return;
                        }
                    }
                    // Update modal with author details
                    $('#modalTitle').text(data.name || 'Unknown Author');
                    
                    // Use image proxy for external images in modal
                    let modalCoverUrl = data.image_url || '/static/img/no-cover.png';
                    if (modalCoverUrl && modalCoverUrl.startsWith('http')) {
                        modalCoverUrl = `/api/proxy/image?url=${encodeURIComponent(modalCoverUrl)}`;
                    }
                    $('#modalCover').attr('src', modalCoverUrl);
                    
                    // Create a custom details section for author info
                    let authorInfoHtml = '';
                    
                    // Add personal details
                    if (data.personal_name && data.personal_name !== data.name) {
                        authorInfoHtml += `<p><strong>Full Name:</strong> ${data.personal_name}</p>`;
                    }
                    
                    if (data.birth_date) {
                        authorInfoHtml += `<p><strong>Born:</strong> ${data.birth_date}</p>`;
                    }
                    
                    if (data.death_date) {
                        authorInfoHtml += `<p><strong>Died:</strong> ${data.death_date}</p>`;
                    }
                    
                    // Add work count if available
                    if (data.work_count) {
                        authorInfoHtml += `<p><strong>Works:</strong> ${data.work_count}</p>`;
                    }
                    
                    // Add notable works if available
                    if (data.notable_works && data.notable_works.length > 0) {
                        authorInfoHtml += `<p><strong>Notable Works:</strong></p><ul class="list-unstyled">`;
                        data.notable_works.forEach(work => {
                            authorInfoHtml += `<li>- ${work}</li>`;
                        });
                        authorInfoHtml += `</ul>`;
                    }
                    
                    // Add subjects if available
                    if (data.subjects && data.subjects.length > 0) {
                        authorInfoHtml += `<p><strong>Subjects:</strong></p>`;
                        const subjectsHtml = data.subjects.map(subject => 
                            `<span class="badge bg-secondary me-1 mb-1">${subject}</span>`
                        ).join('');
                        authorInfoHtml += `<div class="mb-3">${subjectsHtml}</div>`;
                    }
                    
                    // Add places if available
                    if (data.places && data.places.length > 0) {
                        authorInfoHtml += `<p><strong>Places:</strong></p>`;
                        const placesHtml = data.places.map(place => 
                            `<span class="badge bg-info me-1 mb-1">${place}</span>`
                        ).join('');
                        authorInfoHtml += `<div class="mb-3">${placesHtml}</div>`;
                    }
                    
                    // Add alternate names if available
                    if (data.alternate_names && data.alternate_names.length > 0) {
                        authorInfoHtml += `<p><strong>Also Known As:</strong> ${data.alternate_names.join(', ')}</p>`;
                    }
                    
                    // Add OpenLibrary link
                    if (data.html_url) {
                        authorInfoHtml += `<p><a href="${data.html_url}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt me-1"></i> View on OpenLibrary</a></p>`;
                    }
                    
                    // Add links to external resources
                    if (data.links && data.links.length > 0) {
                        authorInfoHtml += '<p><strong>External Links:</strong></p><ul class="list-unstyled">';
                        data.links.forEach(link => {
                            authorInfoHtml += `<li><a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.title}</a></li>`;
                        });
                        authorInfoHtml += '</ul>';
                    }
                    
                    // Add Wikipedia link if available
                    if (data.wikipedia) {
                        authorInfoHtml += `<p><a href="${data.wikipedia}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-secondary"><i class="fas fa-globe me-1"></i> Wikipedia</a></p>`;
                    }
                    
                    // Update the modal fields
                    $('#modalAuthor').html(authorInfoHtml);
                    $('#modalPublisher').parent().parent().hide(); // Hide publisher row
                    $('#modalPublishedDate').parent().parent().hide(); // Hide published date row
                    $('#modalISBN').parent().parent().hide(); // Hide ISBN row
                    
                    // Show collection dropdown for authors
                    $('.collection-controls').show();
                    
                    // Store author ID and provider for add to collection button
                    $('#btnAddToCollection').data('author-id', data.id);
                    $('#btnAddToCollection').data('provider', provider);
                    $('#btnAddToCollection').data('content-type', 'AUTHOR');
                    
                    // Change button text to indicate we're adding an author
                    $('#btnAddToCollection').html('<i class="fas fa-plus-circle me-2"></i> Add Author to Collection');
                    
                    // Ensure collections are loaded
                    loadCollections();
                    
                    // Subjects/Genres
                    console.log('Author data:', data);
                    console.log('Subjects:', data.subjects);
                    if (data.subjects && data.subjects.length > 0) {
                        console.log('Subjects length:', data.subjects.length);
                        const genresHtml = data.subjects.map(subject => 
                            `<span class="badge bg-secondary me-1 mb-1">${subject}</span>`
                        ).join('');
                        console.log('Genres HTML:', genresHtml);
                        $('#modalGenres').html(genresHtml);
                    } else {
                        console.log('No subjects available');
                        $('#modalGenres').html('<span class="text-muted">No subjects available</span>');
                    }
                    
                    // Biography
                    if (data.biography) {
                        // Format the biography text properly
                        let formattedBio = data.biography;
                        // Replace newlines with <br> tags
                        formattedBio = formattedBio.replace(/\n/g, '<br>');
                        // Add paragraph tags if not already present
                        if (!formattedBio.includes('<p>')) {
                            formattedBio = `<p>${formattedBio}</p>`;
                        }
                        $('#modalDescription').html(formattedBio);
                    } else {
                        $('#modalDescription').html('<p><em>No biography available. View on OpenLibrary for more information.</em></p>');
                    }
                    
                    // Show Edit and Delete buttons if this is an author from the library (has database ID)
                    if (data.id && !isNaN(data.id)) {
                        $('#btnEditAuthor').show().data('author-id', data.id).data('author-name', data.name);
                        $('#btnDeleteAuthor').show().data('author-id', data.id).data('author-name', data.name);
                    } else {
                        $('#btnEditAuthor').hide();
                        $('#btnDeleteAuthor').hide();
                    }
                },
                error: function(xhr) {
                    console.error('Error fetching author details:', xhr.responseText);
                    $('#modalDescription').text('Error loading author details');
                }
            });
        });
        
        // View book details
        $(document).on('click', '.view-details', function() {
            const bookId = $(this).data('book-id');
            const provider = $(this).data('provider');
            
            // Reset modal title for book details
            $('#bookDetailsModalLabel').text('Book Details');
            
            // Reset modal
            $('#modalTitle').text('Loading...');
            $('#modalCover').attr('src', '/static/img/no-cover.png');
            $('#modalAltTitles').empty();
            $('#modalAuthor').text('');
            $('#modalPublisher').text('');
            $('#modalPublishedDate').text('');
            $('#modalISBN').text('');
            $('#modalGenres').empty();
            $('#modalDescription').text('Loading...');
            
            // Store book ID and provider for add to collection button
            $('#btnAddToCollection').data('book-id', bookId);
            $('#btnAddToCollection').data('provider', provider);
            
            // Store book ID and provider for want to read button
            $('#btnWantToRead').data('book-id', bookId);
            $('#btnWantToRead').data('provider', provider);
            
            // Ensure collections are loaded
            loadCollections();
            
            // Show modal
            const bookModal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
            bookModal.show();
            
            // Fetch book details
            $.ajax({
                url: `/api/metadata/manga/${provider}/${bookId}`,
                method: 'GET',
                success: function(data) {
                    // Update modal with book details
                    $('#modalTitle').text(data.title || 'Unknown Title');
                    
                    // Use image proxy for external images in modal
                    let modalCoverUrl = data.cover_url || '/static/img/no-cover.png';
                    if (modalCoverUrl && modalCoverUrl.startsWith('http')) {
                        modalCoverUrl = `/api/proxy/image?url=${encodeURIComponent(modalCoverUrl)}`;
                    }
                    $('#modalCover').attr('src', modalCoverUrl);
                    
                    // Alternative titles
                    if (data.alternative_titles && data.alternative_titles.length > 0) {
                        $('#modalAltTitles').text('Also known as: ' + data.alternative_titles.join(', '));
                    } else {
                        $('#modalAltTitles').empty();
                    }
                    
                    // Author
                    $('#modalAuthor').text(data.author || 'Unknown');
                    
                    // Publisher
                    $('#modalPublisher').text(data.publisher || 'Unknown');
                    
                    // Published date
                    $('#modalPublishedDate').text(data.published_date || 'Unknown');
                    
                    // ISBN
                    $('#modalISBN').text(data.isbn || 'Unknown');
                    
                    // Genres
                    if (data.genres && data.genres.length > 0) {
                        const genresHtml = data.genres.map(genre => 
                            `<span class="badge bg-secondary me-1 mb-1">${genre}</span>`
                        ).join('');
                        $('#modalGenres').html(genresHtml);
                    } else {
                        $('#modalGenres').html('<span class="text-muted">No genres available</span>');
                    }
                    
                    // Description
                    $('#modalDescription').text(data.description || 'No description available');
                },
                error: function(xhr) {
                    console.error('Error fetching book details:', xhr.responseText);
                    $('#modalDescription').text('Error loading book details');
                }
            });
        });
        
        // Add to collection button click
        $('#btnAddToCollection').on('click', function() {
            const bookId = $(this).data('book-id');
            const authorId = $(this).data('author-id');
            const provider = $(this).data('provider');
            const contentType = $(this).data('content-type') || 'BOOK';
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Adding...');
            
            // Determine which API to use based on content type
            let apiUrl;
            let requestData;
            
            if (contentType === 'AUTHOR') {
                apiUrl = `/api/metadata/author/import/${provider}/${authorId}`;
                requestData = {
                    collection_id: $('#modalCollection').val() || null,
                    root_folder_id: $('#modalRootFolder').val() || null,
                };
            } else {
                // Use the enhanced book import API that creates author folders
                apiUrl = `/api/metadata/enhanced_import/${provider}/${bookId}`;
                requestData = {
                    content_type: 'BOOK',
                    collection_id: $('#modalCollection').val() || null,
                    root_folder_id: $('#modalRootFolder').val() || null,
                };
            }
            
            // Import to collection
            $.ajax({
                url: apiUrl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                success: function(data) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    // Close details modal
                    bootstrap.Modal.getInstance(document.getElementById('bookDetailsModal')).hide();
                    
                    if (data.success) {
                        // Show success modal with folder information
                        let successMessage = data.message;
                        
                        // Add folder path information if available
                        if (contentType === 'AUTHOR' && data.folder_path) {
                            successMessage += `<br><br>Author folder created: <code>${data.folder_path}</code>`;
                        } else if (data.author_folder_path && data.book_folder_path) {
                            successMessage += `<br><br>Author folder: <code>${data.author_folder_path}</code><br>Book folder: <code>${data.book_folder_path}</code>`;
                        } else if (data.folder_path) {
                            successMessage += `<br><br>Folder created: <code>${data.folder_path}</code>`;
                        }
                        
                        $('#importSuccessMessage').html(successMessage);
                        
                        if (contentType === 'AUTHOR') {
                            // For authors, link to the author page if available
                            if (data.author_id) {
                                $('#viewBookLink').text('View Author');
                                $('#viewBookLink').attr('href', `/authors/${data.author_id}`);
                            } else {
                                // Hide the view link if no author ID
                                $('#viewBookLink').hide();
                            }
                        } else {
                            // For books, link to the book page
                            $('#viewBookLink').text('View Book');
                            $('#viewBookLink').attr('href', `/books/${data.series_id}`);
                        }
                        
                        const successModal = new bootstrap.Modal(document.getElementById('importSuccessModal'));
                        successModal.show();
                    } else if (data.already_exists) {
                        // Show already exists notification
                        if (contentType === 'AUTHOR') {
                            // For authors, show a message that allows adding books
                            let message = 'This author is already in your collection.';
                            
                            // Add a button to search for books by this author
                            message += '<br><br><button id="searchAuthorBooks" class="btn btn-sm btn-primary">Search for books by this author</button>';
                            
                            $('#importSuccessMessage').html(message);
                            
                            // Add click handler for the search button
                            $('#searchAuthorBooks').on('click', function() {
                                // Close the success modal
                                bootstrap.Modal.getInstance(document.getElementById('importSuccessModal')).hide();
                                
                                // Get the author name from the modal title
                                const authorName = $('#modalTitle').text();
                                
                                // Set the search type to title and search for the author name
                                $('#searchTypeSelect').val('title');
                                $('#searchQuery').val(authorName);
                                $('#searchForm').submit();
                            });
                            
                            if (data.author_id) {
                                $('#viewBookLink').text('View Author');
                                $('#viewBookLink').attr('href', `/authors/${data.author_id}`);
                            } else {
                                // Hide the view link if no author ID
                                $('#viewBookLink').hide();
                            }
                        } else {
                            $('#importSuccessMessage').text('This book is already in your collection');
                            $('#viewBookLink').text('View Book');
                            $('#viewBookLink').attr('href', `/books/${data.series_id}`);
                        }
                        
                        const successModal = new bootstrap.Modal(document.getElementById('importSuccessModal'));
                        successModal.show();
                    } else {
                        notificationManager.error(data.message || 'Failed to add to collection');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    console.error('Error importing book:', xhr.responseText);
                    notificationManager.error('Failed to add to collection');
                }
            });
        });
        
        // Want to read button click
        $('#btnWantToRead').on('click', function() {
            const bookId = $(this).data('book-id');
            const provider = $(this).data('provider');
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Adding...');
            
            // Add to want to read collection
            $.ajax({
                url: `/api/metadata/want-to-read/${provider}/${bookId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    content_type: 'BOOK',
                }),
                success: function(data) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    // Close details modal
                    bootstrap.Modal.getInstance(document.getElementById('bookDetailsModal')).hide();
                    
                    if (data.success) {
                        notificationManager.success('Added to "Want to read"', data.message);
                    } else {
                        notificationManager.error(data.message || 'Failed to add to want to read');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    console.error('Error adding to want to read:', xhr.responseText);
                    notificationManager.error('Failed to add to want to read');
                }
            });
        });
        
        // Helper function to show toast notifications
        function showToast(type, title, message) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                $('body').append('<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
            }
            
            $('#toastContainer').append(toastHtml);
            const toastElement = $('#toastContainer .toast').last();
            const toast = new bootstrap.Toast(toastElement[0], { autohide: true, delay: 5000 });
            toast.show();
        }
        
        // Edit Author button click
        $(document).on('click', '#btnEditAuthor', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            
            // Close the current modal
            bootstrap.Modal.getInstance(document.getElementById('bookDetailsModal')).hide();
            
            // Redirect to authors page with edit modal
            // For now, we'll show an alert and redirect to the authors page
            window.location.href = '/books/authors';
        });
        
        // Delete Author button click
        $(document).on('click', '#btnDeleteAuthor', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            
            // Show confirmation
            if (confirm(`Are you sure you want to delete the author "${authorName}"? This will also delete all their books. README files will be preserved.`)) {
                // Disable button and show loading state
                const $btn = $(this);
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Deleting...');
                
                // Delete author
                $.ajax({
                    url: `/api/authors/${authorId}`,
                    method: 'DELETE',
                    success: function(response) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        if (response.success) {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('bookDetailsModal')).hide();
                            
                            // Show success message
                            notificationManager.success('Author deleted successfully');
                            
                            // Reload the page after a short delay
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            notificationManager.error(response.error || 'Failed to delete author');
                        }
                    },
                    error: function(xhr) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        notificationManager.error(xhr.responseJSON?.error || 'Failed to delete author');
                    }
                });
            }
        });
    });
</script>

<style>
    .book-cover {
        height: 250px;
        object-fit: cover;
    }
    
    .author-cover {
        height: 200px;
        object-fit: cover;
        border-radius: 0;
    }
    
    #modalCover {
        max-height: 300px;
        object-fit: contain;
    }
    
    #modalDescription {
        max-height: 200px;
        overflow-y: auto;
        line-height: 1.5;
    }
    
    .description-box {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    #modalGenres .badge {
        margin-right: 5px;
        margin-bottom: 5px;
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    #modalAuthor p {
        margin-bottom: 0.5rem;
    }
    
    #modalAuthor ul {
        padding-left: 1rem;
    }
    
    #modalAuthor .badge {
        margin-right: 5px;
        margin-bottom: 5px;
    }
</style>
{% endblock %}
