{% extends 'base.html' %}

{% block title %}Readloom - {{ book.title }}{% endblock %}

{% block content %}
<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11" id="toast-container"></div>

<!-- Store referrer for smart redirect -->
<script>
    // Store the referrer page for smart redirect after deletion
    if (document.referrer) {
        sessionStorage.setItem('bookPageReferrer', document.referrer);
    }
</script>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">{{ book.title }}</h5>
                <div class="d-flex gap-3">
                    <button id="btnWantToReadDetail" class="btn btn-sm btn-warning rounded-circle" title="Remove from Want to Read">
                        <i class="fa-solid fa-bookmark"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#editSeriesModal" title="Edit Book">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" data-bs-toggle="modal" data-bs-target="#moveSeriesModal" title="Move Book">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger rounded-circle" data-bs-toggle="modal" data-bs-target="#deleteBookModal" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-4">
                        {% if book.cover_url %}
                            <img src="{{ book.cover_url }}" alt="{{ book.title }}" class="img-fluid rounded mb-3">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center rounded mb-3" style="height: 300px;">
                                <i class="fas fa-book fa-5x text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-9">
                        <h4>{{ book.title }}</h4>
                        {% if book.alternative_titles %}
                            <p class="text-muted">Also known as: {{ book.alternative_titles|join(', ') }}</p>
                        {% endif %}
                        
                        <div class="mb-3">
                            <strong>Author:</strong> 
                            {% if author %}
                                <a href="{{ url_for('ui.author_view', author_id=author.id) }}">{{ book.author }}</a>
                            {% else %}
                                {{ book.author }}
                            {% endif %}
                        </div>
                        
                        {% if book.publisher %}
                            <div class="mb-3">
                                <strong>Publisher:</strong> {{ book.publisher }}
                            </div>
                        {% endif %}
                        
                        {% if book.published_date %}
                            <div class="mb-3">
                                <strong>Published:</strong> {{ book.published_date }}
                            </div>
                        {% endif %}
                        
                        {% if book.isbn %}
                            <div class="mb-3">
                                <strong>ISBN:</strong> {{ book.isbn }}
                            </div>
                        {% endif %}
                        
                        {% if book.subjects %}
                            <div class="mb-3">
                                <strong>Genres:</strong>
                                <div class="mt-1">
                                    {% set genre_list = book.subjects.split(',') if book.subjects is string else book.subjects %}
                                    {% for genre in genre_list %}
                                        <span class="badge bg-secondary me-1 mb-1">{{ genre.strip() }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if book.description %}
                            <div class="mb-3">
                                <strong>Description:</strong>
                                <p class="mt-1">{{ book.description }}</p>
                            </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <strong>Collection:</strong> 
                            {% if collection %}
                                <a href="{{ url_for('ui.collection_view', collection_id=collection.id) }}">{{ collection.name }}</a>
                            {% else %}
                                <span class="text-muted">Not in any collection</span>
                            {% endif %}
                        </div>
                        
                        {% if book.metadata_source %}
                            <div class="mb-3">
                                <strong>Source:</strong> {{ book.metadata_source }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Book Status Card -->
<div class="card mb-4" id="book-status-card">
    <div class="card-header">
        <h5 class="mb-0">Reading Status</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <!-- Star Rating -->
                <div class="mb-4">
                    <label class="form-label"><strong>Star Rating</strong></label>
                    <div class="d-flex align-items-center gap-2">
                        <div id="star-rating-display" class="star-rating">
                            {% for i in range(5) %}
                                <i class="fas fa-star {% if book.star_rating and i < book.star_rating|int %}text-warning{% else %}text-muted{% endif %} star-icon" data-rating="{{ i + 1 }}" style="cursor: pointer; font-size: 1.5rem;"></i>
                            {% endfor %}
                        </div>
                        <span id="rating-value" class="badge bg-info">{{ book.star_rating|default(0)|int }}/5</span>
                    </div>
                    <small class="form-text text-muted mt-2">Click on stars to rate this book</small>
                </div>
                
                <!-- Reading Progress -->
                <div class="mb-4">
                    <label class="form-label"><strong>Reading Progress</strong></label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="reading-progress" id="progress-0" value="0" {% if not book.reading_progress or book.reading_progress == 0 %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="progress-0">0%</label>
                        
                        <input type="radio" class="btn-check" name="reading-progress" id="progress-25" value="25" {% if book.reading_progress == 25 %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="progress-25">25%</label>
                        
                        <input type="radio" class="btn-check" name="reading-progress" id="progress-50" value="50" {% if book.reading_progress == 50 %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="progress-50">50%</label>
                        
                        <input type="radio" class="btn-check" name="reading-progress" id="progress-75" value="75" {% if book.reading_progress == 75 %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="progress-75">75%</label>
                        
                        <input type="radio" class="btn-check" name="reading-progress" id="progress-100" value="100" {% if book.reading_progress == 100 %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="progress-100">100%</label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <!-- Custom Description -->
                <div class="mb-4">
                    <label for="user-description" class="form-label"><strong>Your Notes</strong></label>
                    <textarea class="form-control" id="user-description" rows="6" placeholder="Add your personal notes about this book...">{{ book.user_description|default('') }}</textarea>
                    <small class="form-text text-muted mt-2">Share your thoughts, favorite quotes, or reading notes</small>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" id="reset-status-btn">Reset</button>
            <button type="button" class="btn btn-primary" id="save-status-btn">
                <i class="fas fa-save me-1"></i> Save Status
            </button>
        </div>
    </div>
</div>

<!-- Recommendations Card -->
<div class="card mb-4" id="recommendations-card">
    <div class="card-header">
        <h5 class="mb-0">Recommended for You</h5>
    </div>
    <div class="card-body">
        <div id="recommendations-container" class="row">
            <div class="col-12">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Loading recommendations...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- E-book Management Card -->
<div class="card mb-4" id="ebook-management-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">E-book Management</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#ebookManagementCollapse" aria-expanded="false" aria-controls="ebookManagementCollapse">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    <div class="collapse" id="ebookManagementCollapse">
        <div class="card-body">
            <div class="mb-3">
                <strong>Folder Location</strong>
                <p class="mb-1">Place your e-book files in this folder: <code id="folder-path-info-management">Loading...</code></p>
            </div>
            <div class="mb-3">
                <strong>Supported file formats:</strong> PDF, EPUB, CBZ, CBR, MOBI, AZW
            </div>
            <div class="mb-3">
                <strong>Naming convention:</strong> "Volume 1.pdf", "Vol 2.epub", "v3.cbz"
            </div>
            <div class="mb-3">
                <strong>To set a custom path for this book, use the Edit Series button above.</strong>
            </div>
            <div class="mb-3">
                <strong>Scan your data directory for e-books and automatically add them to the database</strong>
                <div class="mt-2">
                    <button class="btn btn-primary" id="scan-for-ebooks">
                        <i class="fas fa-search me-1"></i> Scan for E-books
                    </button>
                </div>
            </div>
            <hr>
            <div class="mb-3">
                <strong>E-book Files:</strong>
                {% if ebook_files %}
                    <div class="mt-2">
                        {% for file in ebook_files %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>{{ file.file_name }}</span>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('api_ebooks.download_file', file_id=file.id) }}" class="btn btn-outline-primary" target="_blank" title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button class="btn btn-outline-danger delete-ebook-file" data-file-id="{{ file.id }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mt-2">No e-book files uploaded</p>
                {% endif %}
            </div>
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadEbookModal">
                    <i class="fas fa-upload me-1"></i> Upload E-book File
                </button>
            </div>
        </div>
    </div>
    <!-- Quick Actions Footer -->
    <div class="card-footer d-flex justify-content-between align-items-center">
        <span class="text-muted small">Quick Actions</span>
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadEbookModal" title="Move Series">
                <i class="fas fa-arrows-alt"></i> Move
            </button>
            <button class="btn btn-primary" id="scan-for-ebooks-quick">
                <i class="fas fa-search me-1"></i> Scan for E-books
            </button>
        </div>
    </div>
</div>

<!-- Move Series Modal -->
<div class="modal fade" id="moveSeriesModal" tabindex="-1" aria-labelledby="moveSeriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveSeriesModalLabel">Move Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="move-series-form">
                    <div class="mb-3">
                        <label for="move-target-collection" class="form-label">Target Collection</label>
                        <select class="form-select" id="move-target-collection"></select>
                        <div class="form-text">Only collections in the same bucket as this series are listed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="move-target-root-folder" class="form-label">Target Root Folder (optional)</label>
                        <select class="form-select" id="move-target-root-folder">
                            <option value="">Auto-select first root folder</option>
                        </select>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="move-files-switch">
                        <label class="form-check-label" for="move-files-switch">Physically move files</label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="clear-custom-path-switch">
                        <label class="form-check-label" for="clear-custom-path-switch">Clear custom path after move</label>
                    </div>
                    <div class="border rounded p-2 bg-light">
                        <div class="small text-muted">Dry Run Preview</div>
                        <pre id="move-dryrun-output" class="mb-0" style="white-space: pre-wrap; max-height: 200px; overflow:auto;">No plan yet</pre>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="move-dryrun-btn">Preview (Dry Run)</button>
                <button type="button" class="btn btn-primary" id="move-execute-btn">Execute Move</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Series Modal -->
<div class="modal fade" id="editSeriesModal" tabindex="-1" aria-labelledby="editSeriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSeriesModalLabel">Edit Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSeriesForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="seriesTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="seriesTitle" value="{{ book.title }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="seriesAuthor" class="form-label">Author</label>
                                <input type="text" class="form-control" id="seriesAuthor" value="{{ book.author }}">
                            </div>
                            <div class="mb-3">
                                <label for="seriesPublisher" class="form-label">Publisher</label>
                                <input type="text" class="form-control" id="seriesPublisher" value="{{ book.publisher }}">
                            </div>
                            <div class="mb-3">
                                <label for="seriesPublishedDate" class="form-label">Published Date</label>
                                <input type="text" class="form-control" id="seriesPublishedDate" value="{{ book.published_date }}">
                            </div>
                            <div class="mb-3">
                                <label for="seriesISBN" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="seriesISBN" value="{{ book.isbn }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="seriesCoverURL" class="form-label">Cover URL</label>
                                <input type="text" class="form-control" id="seriesCoverURL" value="{{ book.cover_url }}">
                            </div>
                            <div class="mb-3">
                                <label for="seriesGenres" class="form-label">Genres (comma-separated)</label>
                                <input type="text" class="form-control" id="seriesGenres" value="{{ book.subjects or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="seriesCollection" class="form-label">Collection</label>
                                <select class="form-select" id="seriesCollection">
                                    <option value="">-- None --</option>
                                    {% if book_collections %}
                                        {% for coll in book_collections %}
                                            <option value="{{ coll.id }}" {% if collection and collection.id == coll.id %}selected{% endif %}>{{ coll.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="seriesCustomPath" class="form-label">Custom Folder Path (optional)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="seriesCustomPath" value="{{ book.folder_path or '' }}">
                                    <button class="btn btn-outline-secondary" type="button" id="browse-book-custom-path-btn">
                                        <i class="fas fa-folder-open"></i> Browse
                                    </button>
                                </div>
                                <div class="form-text">Leave empty to use default collection path</div>
                                <input type="file" id="book-custom-path-picker" style="display: none;" webkitdirectory directory multiple>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="seriesDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="seriesDescription" rows="5">{{ book.description }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSeriesBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Book Modal (kept for backward compatibility) -->
<div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBookModalLabel">Edit Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editBookForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="bookTitle" value="{{ book.title }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="bookAuthor" class="form-label">Author</label>
                                <input type="text" class="form-control" id="bookAuthor" value="{{ book.author }}">
                            </div>
                            <div class="mb-3">
                                <label for="bookPublisher" class="form-label">Publisher</label>
                                <input type="text" class="form-control" id="bookPublisher" value="{{ book.publisher }}">
                            </div>
                            <div class="mb-3">
                                <label for="bookPublishedDate" class="form-label">Published Date</label>
                                <input type="text" class="form-control" id="bookPublishedDate" value="{{ book.published_date }}">
                            </div>
                            <div class="mb-3">
                                <label for="bookISBN" class="form-label">ISBN</label>
                                <input type="text" class="form-control" id="bookISBN" value="{{ book.isbn }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bookCoverURL" class="form-label">Cover URL</label>
                                <input type="text" class="form-control" id="bookCoverURL" value="{{ book.cover_url }}">
                            </div>
                            <div class="mb-3">
                                <label for="bookGenres" class="form-label">Genres (comma-separated)</label>
                                <input type="text" class="form-control" id="bookGenres" value="{{ book.genres|join(', ') if book.genres else '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="bookCollection" class="form-label">Collection</label>
                                <select class="form-select" id="bookCollection">
                                    <option value="">-- None --</option>
                                    {% if book_collections %}
                                        {% for coll in book_collections %}
                                            <option value="{{ coll.id }}" {% if collection and collection.id == coll.id %}selected{% endif %}>{{ coll.name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bookDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="bookDescription" rows="5">{{ book.description }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBookBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Book Modal -->
<div class="modal fade" id="deleteBookModal" tabindex="-1" aria-labelledby="deleteBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBookModalLabel">Delete Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ book.title }}</strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="deleteFiles">
                    <label class="form-check-label" for="deleteFiles">
                        Also delete e-book files from disk
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload E-book Modal -->
<div class="modal fade" id="uploadEbookModal" tabindex="-1" aria-labelledby="uploadEbookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadEbookModalLabel">Upload E-book File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadEbookForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ebookFile" class="form-label">E-book File</label>
                        <input type="file" class="form-control" id="ebookFile" name="file" accept=".epub,.pdf,.mobi,.azw,.azw3,.cbz,.cbr" required>
                    </div>
                    <div class="mb-3">
                        <label for="fileType" class="form-label">File Type</label>
                        <select class="form-select" id="fileType" name="file_type">
                            <option value="EPUB">EPUB</option>
                            <option value="PDF">PDF</option>
                            <option value="MOBI">MOBI</option>
                            <option value="AZW">AZW</option>
                            <option value="AZW3">AZW3</option>
                            <option value="CBZ">CBZ</option>
                            <option value="CBR">CBR</option>
                        </select>
                    </div>
                    <input type="hidden" name="series_id" value="{{ book.id }}">
                    <input type="hidden" name="volume_id" value="{{ volume.id if volume else 1 }}">
                </form>
                <div class="progress mt-3 d-none" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadEbookBtn">Upload</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Helper function to show toast notifications - defined immediately in global scope
    function showToast(type, title, message) {
        const bgColor = type === 'error' ? 'danger' : type;
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${bgColor}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong>: ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        const $toast = $(toastHtml);
        $('#toast-container').append($toast);
        
        const toast = new bootstrap.Toast($toast[0]);
        toast.show();
        
        // Remove the toast element after it's hidden
        $toast.on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }
    
    $(document).ready(function() {
        // Auto-select file type based on file extension
        $('#ebookFile').on('change', function() {
            const fileName = $(this).val().toLowerCase();
            if (fileName.endsWith('.epub')) {
                $('#fileType').val('EPUB');
            } else if (fileName.endsWith('.pdf')) {
                $('#fileType').val('PDF');
            } else if (fileName.endsWith('.mobi')) {
                $('#fileType').val('MOBI');
            } else if (fileName.endsWith('.azw')) {
                $('#fileType').val('AZW');
            } else if (fileName.endsWith('.azw3')) {
                $('#fileType').val('AZW3');
            } else if (fileName.endsWith('.cbz')) {
                $('#fileType').val('CBZ');
            } else if (fileName.endsWith('.cbr')) {
                $('#fileType').val('CBR');
            }
        });
        
        // Upload e-book file
        $('#uploadEbookBtn').on('click', function() {
            const fileInput = $('#ebookFile')[0];
            if (!fileInput.files || fileInput.files.length === 0) {
                notificationManager.warning('Please select a file to upload');
                return;
            }
            
            // Create form data
            const formData = new FormData($('#uploadEbookForm')[0]);
            
            // Disable button and show progress
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Uploading...');
            $('#uploadProgress').removeClass('d-none');
            
            // Upload file
            $.ajax({
                url: '/api/ebooks/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            $('#uploadProgress .progress-bar').css('width', percent + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    if (response.file) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('uploadEbookModal')).hide();
                        
                        // Show success message
                        notificationManager.success('E-book file uploaded successfully');
                        
                        // Reload the page to show the new file
                        location.reload();
                    } else {
                        notificationManager.error(response.error || 'Failed to upload e-book file');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to upload e-book file');
                }
            });
        });
        
        // Save book changes
        $('#saveBookBtn').on('click', function() {
            const title = $('#bookTitle').val();
            const author = $('#bookAuthor').val();
            const publisher = $('#bookPublisher').val();
            const publishedDate = $('#bookPublishedDate').val();
            const isbn = $('#bookISBN').val();
            const coverURL = $('#bookCoverURL').val();
            const genres = $('#bookGenres').val().split(',').map(g => g.trim()).filter(g => g);
            const description = $('#bookDescription').val();
            const collectionId = $('#bookCollection').val();
            
            if (!title) {
                notificationManager.warning('Book title is required');
                return;
            }
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Saving...');
            
            // Update book
            $.ajax({
                url: '/api/series/{{ book.id }}',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    title: title,
                    author: author,
                    publisher: publisher,
                    published_date: publishedDate,
                    isbn: isbn,
                    cover_url: coverURL,
                    genres: genres,
                    description: description
                }),
                success: function(response) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    if (response.success || response.series) {
                        // Update collection if changed
                        if (collectionId) {
                            $.ajax({
                                url: `/api/collections/${collectionId}/series`,
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    series_id: {{ book.id }}
                                }),
                                success: function() {
                                    // Close modal
                                    bootstrap.Modal.getInstance(document.getElementById('editBookModal')).hide();
                                    
                                    // Show success notification using NotificationManager
                                    notificationManager.success('Book updated successfully');
                                    
                                    // Reload the page to show the changes
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1500);
                                },
                                error: function() {
                                    // Close modal anyway
                                    bootstrap.Modal.getInstance(document.getElementById('editBookModal')).hide();
                                    
                                    // Show partial success message
                                    notificationManager.warning('Book updated but collection assignment failed');
                                    
                                    // Reload the page to show the changes
                                    location.reload();
                                }
                            });
                        } else {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('editBookModal')).hide();
                            
                            // Show success message
                            notificationManager.success('Book updated successfully');
                            
                            // Reload the page to show the changes
                            location.reload();
                        }
                    } else {
                        notificationManager.error(response.message || 'Failed to update book');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to update book');
                }
            });
        });
        
        // Save series changes
        $('#saveSeriesBtn').on('click', function() {
            const title = $('#seriesTitle').val();
            const author = $('#seriesAuthor').val();
            const publisher = $('#seriesPublisher').val();
            const publishedDate = $('#seriesPublishedDate').val();
            const isbn = $('#seriesISBN').val();
            const coverURL = $('#seriesCoverURL').val();
            const genres = $('#seriesGenres').val().split(',').map(g => g.trim()).filter(g => g);
            const description = $('#seriesDescription').val();
            const collectionId = $('#seriesCollection').val();
            const customPath = $('#seriesCustomPath').val();
            
            if (!title) {
                notificationManager.warning('Series title is required');
                return;
            }
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Saving...');
            
            // Update series
            $.ajax({
                url: '/api/series/{{ book.id }}',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    title: title,
                    author: author,
                    publisher: publisher,
                    published_date: publishedDate,
                    isbn: isbn,
                    cover_url: coverURL,
                    genres: genres,
                    description: description,
                    folder_path: customPath
                }),
                success: function(response) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    if (response.success || response.series) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('editSeriesModal')).hide();
                        
                        // Show success notification using NotificationManager
                        notificationManager.success('Series updated successfully');
                        
                        // Reload the page to show the changes
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        notificationManager.error(response.message || 'Failed to update series');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to update series');
                }
            });
        });
        
        // Delete ebook file
        $('.delete-ebook-file').on('click', function() {
            const fileId = $(this).data('file-id');
            
            if (confirm('Are you sure you want to delete this ebook file?')) {
                $.ajax({
                    url: `/api/ebooks/${fileId}`,
                    method: 'DELETE',
                    success: function(response) {
                        notificationManager.success('Ebook file deleted successfully');
                        // Reload the page to show the changes
                        location.reload();
                    },
                    error: function(xhr) {
                        notificationManager.error(xhr.responseJSON?.error || 'Failed to delete ebook file');
                    }
                });
            }
        });
        
        // Scan for ebooks
        $('#scan-for-ebooks, #scan-for-ebooks-quick').on('click', function() {
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Scanning...');
            
            $.ajax({
                url: '/api/ebooks/scan',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    series_id: {{ book.id }}
                }),
                success: function(response) {
                    $btn.prop('disabled', false).html(originalText);
                    
                    if (response.success) {
                        notificationManager.success(`Scan completed. Found ${response.stats.added} new files.`);
                        // Reload the page after a short delay to show the new files
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        notificationManager.error(response.error || 'Scan failed');
                    }
                },
                error: function(xhr) {
                    $btn.prop('disabled', false).html(originalText);
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to scan for ebooks');
                }
            });
        });
        
        // Move Series button in Quick Actions
        $('button[title="Move Series"]').on('click', function() {
            // Open the Move Series modal instead
            bootstrap.Modal.getOrCreateInstance(document.getElementById('moveSeriesModal')).show();
        });
        
        // Delete book
        $('#confirmDeleteBtn').on('click', function(e) {
            e.preventDefault();
            console.log('Delete button clicked');
            
            const deleteFiles = $('#deleteFiles').is(':checked');
            const $btn = $(this);
            const originalText = $btn.html();
            
            // Disable button and show loading state
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Deleting...');
            
            console.log('Sending DELETE request for book {{ book.id }}');
            
            // Delete book
            $.ajax({
                url: '/api/series/{{ book.id }}',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({
                    delete_files: deleteFiles
                }),
                timeout: 10000,
                success: function(response) {
                    console.log('Delete successful:', response);
                    
                    // Show success message
                    const toastHtml = `
                        <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <strong>Success</strong>: Book deleted successfully
                                </div>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    `;
                    const $toast = $(toastHtml);
                    $('#toast-container').append($toast);
                    const toast = new bootstrap.Toast($toast[0]);
                    toast.show();
                    
                    // Close the modal
                    const modalElement = document.getElementById('deleteBookModal');
                    if (modalElement) {
                        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                        modal.hide();
                    }
                    
                    // Redirect to books home
                    console.log('Redirecting to books home');
                    setTimeout(() => {
                        window.location.href = "{{ url_for('ui.books_home') }}";
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    console.error('Delete failed:', status, error, xhr);
                    
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    const errorMsg = xhr.responseJSON?.error || error || 'Failed to delete book';
                    
                    // Show error message
                    const toastHtml = `
                        <div class="toast align-items-center text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    <strong>Error</strong>: ${errorMsg}
                                </div>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    `;
                    const $toast = $(toastHtml);
                    $('#toast-container').append($toast);
                    const toast = new bootstrap.Toast($toast[0]);
                    toast.show();
                }
            });
        });
        
        // Function to fetch book folder path
        function fetchBookFolderPath(bookId, bookTitle, contentType) {
            const data = {
                action: 'get_folder_path',
                series_id: bookId,
                title: bookTitle,
                content_type: contentType
            };
            
            fetch('/api/series/folder-path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching folder path:', data.error);
                    $('#folder-path-info-management').text('Error fetching path');
                } else {
                    const folderPath = data.folder_path;
                    $('#folder-path-info-management').text(folderPath);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#folder-path-info-management').text('Error fetching path');
            });
        }
        
        // Fetch folder path on page load
        fetchBookFolderPath({{ book.id }}, '{{ book.title }}', '{{ book.content_type or "BOOK" }}');
        
        // Folder browser functionality
        let currentBrowsePath = null;
        let targetInputId = null;
        
        function openFolderBrowser(inputId) {
            targetInputId = inputId;
            currentBrowsePath = null;
            const currentValue = $(`#${inputId}`).val();
            
            // Start from home directory or current value
            if (currentValue) {
                currentBrowsePath = currentValue;
            }
            
            loadFolderBrowserPath(currentBrowsePath);
            bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).show();
        }
        
        function loadFolderBrowserPath(path) {
            $.ajax({
                url: '/api/folders/browse',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ path: path }),
                success: function(response) {
                    if (response.success) {
                        currentBrowsePath = response.current_path;
                        $('#folderBrowserCurrentPath').val(currentBrowsePath);
                        $('#folderBrowserSelectedPath').val(currentBrowsePath);
                        
                        // Display drives if available
                        if (response.drives && response.drives.length > 0) {
                            $('#folderBrowserDrivesContainer').show();
                            const drivesHtml = response.drives.map(drive => 
                                `<button type="button" class="btn btn-outline-secondary folder-drive-btn" data-path="${drive}">${drive}</button>`
                            ).join('');
                            $('#folderBrowserDrives').html(drivesHtml);
                        } else {
                            $('#folderBrowserDrivesContainer').hide();
                        }
                        
                        // Display folders
                        if (response.folders && response.folders.length > 0) {
                            const foldersHtml = response.folders.map(folder => 
                                `<div class="list-group-item list-group-item-action cursor-pointer folder-item" data-path="${folder.path}">
                                    <i class="fas fa-folder me-2"></i>${folder.name}
                                </div>`
                            ).join('');
                            $('#folderBrowserList').html(foldersHtml);
                        } else {
                            $('#folderBrowserList').html('<div class="text-center text-muted">No folders found</div>');
                        }
                    } else {
                        notificationManager.error(response.error || 'Failed to load folders');
                    }
                },
                error: function(xhr) {
                    notificationManager.error('Failed to browse folders');
                }
            });
        }
        
        // Browse button click handler
        $('#browse-book-custom-path-btn').on('click', function() {
            openFolderBrowser('seriesCustomPath');
        });
        
        // Folder item click
        $(document).on('click', '.folder-item', function() {
            const path = $(this).data('path');
            loadFolderBrowserPath(path);
        });
        
        // Drive button click
        $(document).on('click', '.folder-drive-btn', function() {
            const path = $(this).data('path');
            loadFolderBrowserPath(path);
        });
        
        // Up button
        $(document).on('click', '#folderBrowserUpBtn', function() {
            if (currentBrowsePath) {
                const lastBackslash = currentBrowsePath.lastIndexOf('\\');
                const lastForwardSlash = currentBrowsePath.lastIndexOf('/');
                const lastSeparator = Math.max(lastBackslash, lastForwardSlash);
                if (lastSeparator > 0) {
                    const parentPath = currentBrowsePath.substring(0, lastSeparator);
                    if (parentPath !== currentBrowsePath) {
                        loadFolderBrowserPath(parentPath);
                    }
                }
            }
        });
        
        $(document).on('click', '#folderBrowserHomeBtn', function() {
            loadFolderBrowserPath(null);
        });
        
        $(document).on('click', '#folderBrowserSelectBtn', function() {
            if (targetInputId && currentBrowsePath) {
                $(`#${targetInputId}`).val(currentBrowsePath);
                bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).hide();
            }
        });
    });
</script>

<!-- Folder Browser Modal -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="folderBrowserModalLabel">Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="folderBrowserCurrentPath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserUpBtn">
                            <i class="fas fa-arrow-up"></i> Up
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserHomeBtn">
                            <i class="fas fa-home"></i> Home
                        </button>
                    </div>
                </div>
                
                <!-- Windows Drives -->
                <div id="folderBrowserDrivesContainer" class="mb-3" style="display: none;">
                    <label class="form-label">Drives:</label>
                    <div id="folderBrowserDrives" class="btn-group w-100 flex-wrap" role="group"></div>
                </div>
                
                <!-- Folders List -->
                <div class="mb-3">
                    <label class="form-label">Folders:</label>
                    <div id="folderBrowserList" class="list-group" style="height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Selected Path:</label>
                    <input type="text" class="form-control" id="folderBrowserSelectedPath" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="folderBrowserSelectBtn">Select</button>
            </div>
        </div>
    </div>
</div>

<!-- Book Status Management -->
<script src="{{ url_for('static', filename='js/book-status.js') }}"></script>

<!-- Book Recommendations -->
<script src="{{ url_for('static', filename='js/book-recommendations.js') }}"></script>

<!-- Want to Read Button Handler -->
<script>
    $(document).ready(function() {
        $('#btnWantToReadDetail').on('click', function() {
            const seriesId = {{ book.id }};
            const provider = '{{ book.metadata_source or "unknown" }}';
            const metadataId = '{{ book.metadata_id or "" }}';
            const contentType = '{{ book.content_type or "BOOK" }}';
            
            // If no metadata source, show error
            if (!provider || provider === 'unknown' || !metadataId) {
                notificationManager.error('Cannot manage Want to read', 'This book does not have metadata source information');
                return;
            }
            
            const $btn = $(this);
            const originalHtml = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            // Check if already in want-to-read by checking button state
            const isInWantToRead = $btn.hasClass('btn-warning');
            const method = isInWantToRead ? 'DELETE' : 'POST';
            
            $.ajax({
                url: `/api/metadata/want-to-read/${provider}/${metadataId}`,
                method: method,
                contentType: 'application/json',
                data: method === 'POST' ? JSON.stringify({
                    content_type: contentType
                }) : undefined,
                success: function(data) {
                    $btn.prop('disabled', false).html(originalHtml);
                    if (data.success) {
                        if (method === 'POST') {
                            notificationManager.success('Added to "Want to read"', data.message);
                            // Update button to show remove state
                            $btn.removeClass('btn-outline-warning').addClass('btn-warning');
                            $btn.attr('title', 'Remove from Want to Read');
                        } else {
                            notificationManager.success('Removed from "Want to read"', data.message);
                            // Update button to show add state
                            $btn.removeClass('btn-warning').addClass('btn-outline-warning');
                            $btn.attr('title', 'Add to Want to Read');
                        }
                    } else {
                        notificationManager.error('Failed to manage want to read', data.message);
                    }
                },
                error: function(xhr) {
                    $btn.prop('disabled', false).html(originalHtml);
                    console.error('Error managing want to read:', xhr);
                    notificationManager.error('Failed to manage want to read');
                }
            });
        });
    });
</script>

{% endblock %}
