{% extends "books_layout.html" %}

{% block book_title %}Authors{% endblock %}

{% block book_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Authors</h5>
        <div>
            <button class="btn btn-outline-primary btn-sm me-2" id="btnAddAuthor">
                <i class="fas fa-plus me-1"></i> Add Author
            </button>
            <a href="{{ url_for('ui.books_search') if 'books_search' in url_for_map else '#' }}" class="btn btn-primary btn-sm">
                <i class="fas fa-search me-1"></i> Find Books
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <input type="text" class="form-control" id="authorSearchInput" placeholder="Search authors...">
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="authorsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Books</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if authors %}
                        {% for author in authors %}
                            <tr>
                                <td>
                                    <a href="#" class="view-author-details" data-author-id="{{ author.id }}">{{ author.name }}</a>
                                </td>
                                <td>{{ author.book_count }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary view-author-details" data-author-id="{{ author.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary edit-author" data-author-id="{{ author.id }}" data-author-name="{{ author.name }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if author.book_count == 0 %}
                                            <button class="btn btn-outline-danger delete-author" data-author-id="{{ author.id }}" data-author-name="{{ author.name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-outline-danger" disabled title="Cannot delete author with books">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <i class="fas fa-user-edit fa-3x text-muted mb-3"></i>
                                <p>No authors found in your library</p>
                                <a href="{{ url_for('ui.books_search') if 'books_search' in url_for_map else '#' }}" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i> Search for Books
                                </a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Author Modal -->
<div class="modal fade" id="authorModal" tabindex="-1" aria-labelledby="authorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorModalLabel">Add Author</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="authorForm">
                    <input type="hidden" id="authorId">
                    <div class="mb-3">
                        <label for="authorName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="authorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="authorDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="authorDescription" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAuthorBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Author Details Modal -->
<div class="modal fade" id="authorDetailsModal" tabindex="-1" aria-labelledby="authorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <h5 class="modal-title" id="authorDetailsModalLabel">Author Details</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnEditAuthorDetails" title="Edit Author">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="btnDeleteAuthorDetails" title="Delete Author">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <img id="authorDetailsPhoto" src="/static/img/no-cover.png" alt="Author Photo" class="img-fluid rounded">
                    </div>
                    <div class="col-md-8">
                        <h4 id="authorDetailsName"></h4>
                        <p id="authorDetailsBio" class="text-muted"></p>
                        <div id="authorDetailsStats" class="mb-3">
                            <p><strong>Books in Collection:</strong> <span id="authorDetailsBookCount">0</span></p>
                        </div>
                        <div id="authorDetailsMessage" class="alert alert-info" style="display: none;">
                            No books by this author in your library
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Author Confirmation Modal -->
<div class="modal fade" id="deleteAuthorModal" tabindex="-1" aria-labelledby="deleteAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAuthorModalLabel">Delete Author</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the author <strong id="deleteAuthorName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. All books by this author will also be deleted, but README files will be preserved.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAuthorBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Initialize DataTable
        const authorsTable = $('#authorsTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            info: true,
            pageLength: 25,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search authors..."
            }
        });
        
        // Add Author button click
        $('#btnAddAuthor').on('click', function() {
            // Reset form
            $('#authorId').val('');
            $('#authorName').val('');
            $('#authorDescription').val('');
            
            // Update modal title
            $('#authorModalLabel').text('Add Author');
            
            // Show modal
            const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
            authorModal.show();
        });
        
        // Edit Author button click
        $(document).on('click', '.edit-author', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            
            // Get author details
            $.ajax({
                url: `/api/authors/${authorId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const author = response.author;
                        
                        // Fill form
                        $('#authorId').val(author.id);
                        $('#authorName').val(author.name);
                        $('#authorDescription').val(author.description || '');
                        
                        // Update modal title
                        $('#authorModalLabel').text('Edit Author');
                        
                        // Show modal
                        const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
                        authorModal.show();
                    } else {
                        notificationManager.error(response.error || 'Failed to get author details');
                    }
                },
                error: function(xhr) {
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to get author details');
                }
            });
        });
        
        // Delete Author button click
        $(document).on('click', '.delete-author', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            
            // Set author name in confirmation modal
            $('#deleteAuthorName').text(authorName);
            
            // Store author ID for delete confirmation
            $('#confirmDeleteAuthorBtn').data('author-id', authorId);
            
            // Show modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteAuthorModal'));
            deleteModal.show();
        });
        
        // Save author button click
        $('#saveAuthorBtn').on('click', function() {
            const authorId = $('#authorId').val();
            const name = $('#authorName').val();
            const description = $('#authorDescription').val();
            
            if (!name) {
                notificationManager.warning('Author name is required');
                return;
            }
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Saving...');
            
            if (authorId) {
                // Update existing author
                $.ajax({
                    url: `/api/authors/${authorId}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: name,
                        description: description
                    }),
                    success: function(response) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        if (response.success) {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('authorModal')).hide();
                            
                            // Show success message
                            notificationManager.success('Author updated successfully');
                            
                            // Reload the page to show the changes
                            location.reload();
                        } else {
                            notificationManager.error(response.error || 'Failed to update author');
                        }
                    },
                    error: function(xhr) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        notificationManager.error(xhr.responseJSON?.error || 'Failed to update author');
                    }
                });
            } else {
                // Create new author
                $.ajax({
                    url: '/api/authors/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        name: name,
                        description: description
                    }),
                    success: function(response) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        if (response.success) {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('authorModal')).hide();
                            
                            // Show success message
                            notificationManager.success('Author created successfully');
                            
                            // Reload the page to show the changes
                            location.reload();
                        } else {
                            notificationManager.error(response.error || 'Failed to create author');
                        }
                    },
                    error: function(xhr) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        notificationManager.error(xhr.responseJSON?.error || 'Failed to create author');
                    }
                });
            }
        });
        
        // Confirm delete author button click
        $('#confirmDeleteAuthorBtn').on('click', function() {
            const authorId = $(this).data('author-id');
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Deleting...');
            
            // Delete author
            $.ajax({
                url: `/api/authors/${authorId}`,
                method: 'DELETE',
                success: function(response) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    if (response.success) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('deleteAuthorModal')).hide();
                        
                        // Show success message
                        notificationManager.success('Author deleted successfully');
                        
                        // Reload the page to show the changes
                        location.reload();
                    } else {
                        notificationManager.error(response.error || 'Failed to delete author');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to delete author');
                }
            });
        });
        
        // Show author details modal when clicking on author name or view button
        $(document).on('click', '.view-author-details, .author-name-link', function(e) {
            e.preventDefault();
            const authorId = $(this).data('author-id');
            
            // Fetch author details
            $.ajax({
                url: `/api/authors/${authorId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const author = response.author;
                        
                        // Populate modal
                        $('#authorDetailsName').text(author.name);
                        $('#authorDetailsBio').text(author.biography || author.description || 'No biography available');
                        $('#authorDetailsPhoto').attr('src', author.photo_url || '/static/img/no-cover.png');
                        $('#authorDetailsBookCount').text(author.book_count || 0);
                        
                        // Show/hide no books message
                        if (author.book_count === 0) {
                            $('#authorDetailsMessage').show();
                        } else {
                            $('#authorDetailsMessage').hide();
                        }
                        
                        // Store author ID for edit/delete buttons
                        $('#btnEditAuthorDetails').data('author-id', author.id).data('author-name', author.name);
                        $('#btnDeleteAuthorDetails').data('author-id', author.id).data('author-name', author.name);
                        
                        // Show modal
                        const detailsModal = new bootstrap.Modal(document.getElementById('authorDetailsModal'));
                        detailsModal.show();
                    } else {
                        notificationManager.error(response.error || 'Failed to load author details');
                    }
                },
                error: function(xhr) {
                    notificationManager.error(xhr.responseJSON?.error || 'Failed to load author details');
                }
            });
        });
        
        // Edit author from details modal
        $('#btnEditAuthorDetails').on('click', function() {
            const authorId = $(this).data('author-id');
            
            // Close details modal
            bootstrap.Modal.getInstance(document.getElementById('authorDetailsModal')).hide();
            
            // Fetch author data and open edit modal
            $.ajax({
                url: `/api/authors/${authorId}`,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const author = response.author;
                        
                        // Fill form
                        $('#authorId').val(author.id);
                        $('#authorName').val(author.name);
                        $('#authorDescription').val(author.description || '');
                        
                        // Update modal title
                        $('#authorModalLabel').text('Edit Author');
                        
                        // Show modal
                        const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
                        authorModal.show();
                    }
                }
            });
        });
        
        // Delete author from details modal
        $('#btnDeleteAuthorDetails').on('click', function() {
            const authorId = $(this).data('author-id');
            const authorName = $(this).data('author-name');
            
            // Close details modal
            bootstrap.Modal.getInstance(document.getElementById('authorDetailsModal')).hide();
            
            // Set author name in confirmation modal
            $('#deleteAuthorName').text(authorName);
            
            // Store author ID for delete confirmation
            $('#confirmDeleteAuthorBtn').data('author-id', authorId);
            
            // Show delete confirmation modal
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteAuthorModal'));
            deleteModal.show();
        });
    });
</script>
{% endblock %}
