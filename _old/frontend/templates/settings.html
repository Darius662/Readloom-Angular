{% extends 'base.html' %}

{% block title %}Readloom - Settings{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="settings-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="collections-tab" data-bs-toggle="tab" data-bs-target="#collections" type="button" role="tab" aria-controls="collections" aria-selected="false">Collections</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab" aria-controls="calendar" aria-selected="false">Calendar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logging-tab" data-bs-toggle="tab" data-bs-target="#logging" type="button" role="tab" aria-controls="logging" aria-selected="false">Logging</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="integrations-tab" data-bs-toggle="tab" data-bs-target="#integrations" type="button" role="tab" aria-controls="integrations" aria-selected="false">Integrations</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="data-sync-tab" data-bs-toggle="tab" data-bs-target="#data-sync" type="button" role="tab" aria-controls="data-sync" aria-selected="false">Data Sync</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notifications-demo-tab" data-bs-toggle="tab" data-bs-target="#notifications-demo" type="button" role="tab" aria-controls="notifications-demo" aria-selected="false">Notifications Demo</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="settings-tab-content">
                    <!-- General Settings -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <h5 class="card-title">General Settings</h5>
                        <form id="general-settings-form">
                            <div class="mb-3 row">
                                <label for="host" class="col-sm-3 col-form-label">Host</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="host" name="host">
                                    <div class="form-text">The host to bind the server to (e.g., 0.0.0.0)</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="port" class="col-sm-3 col-form-label">Port</label>
                                <div class="col-sm-9">
                                    <input type="number" class="form-control" id="port" name="port" min="1" max="65535">
                                    <div class="form-text">The port to bind the server to (e.g., 7227)</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="url-base" class="col-sm-3 col-form-label">URL Base</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="url-base" name="url_base">
                                    <div class="form-text">The base URL for the application (e.g., /readloom)</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="task-interval" class="col-sm-3 col-form-label">Task Interval</label>
                                <div class="col-sm-9">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="task-interval" name="task_interval_minutes" min="1">
                                        <span class="input-group-text">minutes</span>
                                    </div>
                                    <div class="form-text">How often background tasks should run</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="metadata-cache" class="col-sm-3 col-form-label">Metadata Cache</label>
                                <div class="col-sm-9">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="metadata-cache" name="metadata_cache_days" min="1">
                                        <span class="input-group-text">days</span>
                                    </div>
                                    <div class="form-text">How long to cache metadata before refreshing</div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-primary" id="save-general-settings">Save Settings</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Collections Manager -->
                    <div class="tab-pane fade" id="collections" role="tabpanel" aria-labelledby="collections-tab">
                        <h5 class="card-title">
                            Collections Manager
                            <i class="fas fa-info-circle ms-2" style="cursor: help; color: #0d6efd;" data-bs-toggle="tooltip" data-bs-placement="right" title="Collections allow you to organize your manga/comics into groups and connect them to specific root folders. Each collection can have multiple root folders, and each root folder can be used by multiple collections. You must have at least one collection and one root folder before you can add manga/comics to your library."></i>
                        </h5>

                        <!-- Link Root Folder To Collection Modal -->
                        <div class="modal fade" id="linkRootFolderModal" tabindex="-1" aria-labelledby="linkRootFolderModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="linkRootFolderModalLabel">Link Root Folder to Collection</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="linkRootFolderForm">
                                            <div class="mb-3">
                                                <label for="selectRootFolder" class="form-label">Root Folder</label>
                                                <select class="form-select" id="selectRootFolder" style="pointer-events: auto;">
                                                </select>
                                            </div>
                                        </form>
                                        <div id="linkRootFolderHelp" class="form-text">Only root folders not already in this collection are listed.</div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="confirmLinkRootFolderBtn">Link</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Collections</h5>
                                        <button class="btn btn-sm btn-primary" id="addCollectionBtn">
                                            <i class="fas fa-plus"></i> Add Collection
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="collectionsTable">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Description</th>
                                                        <th>Type</th>
                                                        <th>Root Folders</th>
                                                        <th>Series</th>
                                                        <th>Default</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="collectionsTableBody">
                                                    <tr>
                                                        <td colspan="7" class="text-center">Loading collections...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Root Folders</h5>
                                        <button class="btn btn-sm btn-primary" id="addRootFolderBtn">
                                            <i class="fas fa-plus"></i> Add Root Folder
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="rootFoldersTable">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Path</th>
                                                        <th>Content Type</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="rootFoldersTableBody">
                                                    <tr>
                                                        <td colspan="5" class="text-center">Loading root folders...</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4 d-none" id="collectionDetailsCard">
                            <div class="card-header">
                                <h5 class="mb-0">Collection: <span id="selectedCollectionName">Selected Collection</span></h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <h6 class="mb-0">Root Folders</h6>
                                            <button class="btn btn-sm btn-primary" id="linkRootFolderBtn" data-bs-toggle="modal" data-bs-target="#linkRootFolderModal">
                                                <i class="fas fa-link"></i> Link Root Folder
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped" id="collectionRootFoldersTable">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Path</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="collectionRootFoldersTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Series</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped" id="collectionSeriesTable">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Type</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="collectionSeriesTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Root Folders Settings -->
                    <div class="tab-pane fade" id="root-folders" role="tabpanel" aria-labelledby="root-folders-tab">
                        <h5 class="card-title">Root Folders</h5>
                        <p class="text-muted mb-4">
                            Root folders are where Readloom will store e-book files. Series folders will be created directly inside these root folders.
                            You must set up at least one root folder before you can add series or scan for e-books.
                        </p>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> For detailed root folder management, please visit the <a href="{{ url_for('ui.root_folders') }}" class="alert-link">Root Folders</a> page.
                        </div>
                        
                        <div class="mb-4">
                            <h6>Current Root Folders:</h6>
                            <div id="root-folders-list" class="list-group">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading root folders...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex">
                            <a href="{{ url_for('ui.root_folders') }}" class="btn btn-primary">
                                <i class="fas fa-folder-plus"></i> Manage Root Folders
                            </a>
                        </div>
                    </div>
                    
                    <!-- Calendar Settings -->
                    <div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
                        <h5 class="card-title">Calendar Settings</h5>
                        <form id="calendar-settings-form">
                            <div class="mb-3 row">
                                <label for="calendar-range" class="col-sm-3 col-form-label">Calendar Range</label>
                                <div class="col-sm-9">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="calendar-range" name="calendar_range_days" min="1">
                                        <span class="input-group-text">days</span>
                                    </div>
                                    <div class="form-text">How many days in the future to show in the calendar</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="calendar-refresh" class="col-sm-3 col-form-label">Calendar Refresh</label>
                                <div class="col-sm-9">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="calendar-refresh" name="calendar_refresh_hours" min="1">
                                        <span class="input-group-text">hours</span>
                                    </div>
                                    <div class="form-text">How often to automatically refresh the calendar data</div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-primary" id="save-calendar-settings">Save Settings</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Logging Settings -->
                    <div class="tab-pane fade" id="logging" role="tabpanel" aria-labelledby="logging-tab">
                        <h5 class="card-title">Logging Settings</h5>
                        <form id="logging-settings-form">
                            <div class="mb-3 row">
                                <label for="log-level" class="col-sm-3 col-form-label">Log Level</label>
                                <div class="col-sm-9">
                                    <select class="form-select" id="log-level" name="log_level">
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO">INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                        <option value="CRITICAL">CRITICAL</option>
                                    </select>
                                    <div class="form-text">The minimum log level to record</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="log-rotation" class="col-sm-3 col-form-label">Log Rotation</label>
                                <div class="col-sm-9">
                                    <input type="number" class="form-control" id="log-rotation" name="log_rotation" min="1">
                                    <div class="form-text">Number of log files to keep</div>
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="log-size" class="col-sm-3 col-form-label">Log Size</label>
                                <div class="col-sm-9">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="log-size" name="log_size" min="1">
                                        <span class="input-group-text">MB</span>
                                    </div>
                                    <div class="form-text">Maximum size of each log file in megabytes</div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-primary" id="save-logging-settings">Save Settings</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Integrations Settings -->
                    <div class="tab-pane fade" id="integrations" role="tabpanel" aria-labelledby="integrations-tab">
                        <h5 class="card-title">Integrations</h5>
                        <p class="text-muted mb-4">Configure integrations with external services and metadata providers.</p>
                        
                        <!-- Home Assistant Integration -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Home Assistant</h6>
                                <span class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <img src="https://brands.home-assistant.io/homeassistant/logo.png" alt="Home Assistant Logo" style="width: 40px; height: 40px; margin-right: 15px;">
                                    <div>
                                        <p class="mb-0">Integrate Readloom with your Home Assistant instance</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('ui.home_assistant') }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-cog me-1"></i> Configure
                                </a>
                            </div>
                        </div>
                        
                        <!-- Homarr Integration -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Homarr</h6>
                                <span class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <img src="https://avatars.githubusercontent.com/u/107269758" alt="Homarr Logo" style="width: 40px; height: 40px; margin-right: 15px;">
                                    <div>
                                        <p class="mb-0">Integrate Readloom with your Homarr dashboard</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('ui.homarr') }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-cog me-1"></i> Configure
                                </a>
                            </div>
                        </div>
                        
                        <!-- Metadata Providers Integration -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Metadata Providers</h6>
                                <span class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <i class="fas fa-search fa-2x text-primary" style="width: 40px; height: 40px; margin-right: 15px; display: flex; align-items: center; justify-content: center;"></i>
                                    <div>
                                        <p class="mb-0">Configure metadata providers for e-book search and import</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('ui.provider_config') }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-cog me-1"></i> Configure
                                </a>
                            </div>
                        </div>

                        <!-- AI Providers Integration -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">AI Providers</h6>
                                <span class="badge bg-info">New</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <i class="fas fa-brain fa-2x text-info" style="width: 40px; height: 40px; margin-right: 15px; display: flex; align-items: center; justify-content: center;"></i>
                                    <div>
                                        <p class="mb-0">Configure AI providers for accurate manga metadata extraction</p>
                                    </div>
                                </div>
                                <a href="{{ url_for('ui.ai_providers_config') }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-cog me-1"></i> Configure
                                </a>
                            </div>
                        </div>

                        <!-- Kavita Integration -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Kavita</h6>
                                <span class="badge bg-success">Available</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex mb-3">
                                    <i class="fas fa-book fa-2x text-primary" style="width: 40px; height: 40px; margin-right: 15px; display: flex; align-items: center; justify-content: center;"></i>
                                    <div>
                                        <p class="mb-0">Integrate Readloom with your Kavita server for e-book reading</p>
                                    </div>
                                </div>
                                <form id="kavitaSettingsForm">
                                    <div class="mb-3">
                                        <label for="kavitaUrl" class="form-label">Kavita Server URL</label>
                                        <input type="url" class="form-control" id="kavitaUrl" placeholder="http://localhost:5000">
                                        <small class="form-text text-muted">The base URL of your Kavita server</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="kavitaUsername" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="kavitaUsername" placeholder="your-username">
                                    </div>
                                    <div class="mb-3">
                                        <label for="kavitaPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="kavitaPassword" placeholder="your-password">
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="kavitaEnabled">
                                            <label class="form-check-label" for="kavitaEnabled">
                                                Enable Kavita Integration
                                            </label>
                                        </div>
                                    </div>
                                    <div id="kavitaStatus" class="mb-3"></div>
                                    <button type="button" class="btn btn-sm btn-primary" id="testKavitaBtn">
                                        <i class="fas fa-plug me-1"></i> Test Connection
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success" id="saveKavitaBtn">
                                        <i class="fas fa-save me-1"></i> Save Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Sync Settings -->
                    <div class="tab-pane fade" id="data-sync" role="tabpanel" aria-labelledby="data-sync-tab">
                        <h5 class="card-title">Data Synchronization</h5>
                        <p class="text-muted mb-4">Sync database data to README files for backup and portability.</p>
                        
                        <!-- Author README Sync -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    Author README Sync
                                    <i class="fas fa-info-circle ms-2" style="cursor: help; color: #0d6efd;" data-bs-toggle="tooltip" data-bs-placement="right" title="Synchronize author data from the database to README.md files in author folders. Merge Mode: When enabled, existing README data is preserved. Database values update existing fields, but data only in README files is kept."></i>
                                </h6>
                                <span class="badge bg-info">Utility</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Synchronize author data from the database to README.md files in author folders.</p>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="authorSyncMerge">
                                        <label class="form-check-label" for="authorSyncMerge">
                                            Merge with existing README data (preserve non-database values)
                                        </label>
                                    </div>
                                </div>
                                <div id="authorSyncStatus" class="mb-3"></div>
                                <button type="button" class="btn btn-primary" id="syncAuthorReadmeBtn">
                                    <i class="fas fa-sync me-1"></i> Sync Author READMEs
                                </button>
                            </div>
                        </div>

                        <!-- Book README Sync -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    Book README Sync
                                    <i class="fas fa-info-circle ms-2" style="cursor: help; color: #0d6efd;" data-bs-toggle="tooltip" data-bs-placement="right" title="Synchronize book data from the database to README.txt files in book folders. Merge Mode: When enabled, existing README data is preserved. Database values update existing fields, but data only in README files is kept."></i>
                                </h6>
                                <span class="badge bg-info">Utility</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Synchronize book data from the database to README.txt files in book folders.</p>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bookSyncMerge">
                                        <label class="form-check-label" for="bookSyncMerge">
                                            Merge with existing README data (preserve non-database values)
                                        </label>
                                    </div>
                                </div>
                                <div id="bookSyncStatus" class="mb-3"></div>
                                <button type="button" class="btn btn-primary" id="syncBookReadmeBtn">
                                    <i class="fas fa-sync me-1"></i> Sync Book READMEs
                                </button>
                            </div>
                        </div>

                        <!-- Manga README Sync -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    Manga README Sync
                                    <i class="fas fa-info-circle ms-2" style="cursor: help; color: #0d6efd;" data-bs-toggle="tooltip" data-bs-placement="right" title="Synchronize manga data from the database to README.txt files in manga folders. Merge Mode: When enabled, existing README data is preserved. Database values update existing fields, but data only in README files is kept."></i>
                                </h6>
                                <span class="badge bg-info">Utility</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Synchronize manga data from the database to README.txt files in manga folders.</p>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mangaSyncMerge">
                                        <label class="form-check-label" for="mangaSyncMerge">
                                            Merge with existing README data (preserve non-database values)
                                        </label>
                                    </div>
                                </div>
                                <div id="mangaSyncStatus" class="mb-3"></div>
                                <button type="button" class="btn btn-primary" id="syncMangaReadmeBtn">
                                    <i class="fas fa-sync me-1"></i> Sync Manga READMEs
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Demo -->
                    <div class="tab-pane fade" id="notifications-demo" role="tabpanel" aria-labelledby="notifications-demo-tab">
                        <h5 class="card-title">Notification System Demo</h5>
                        <p class="text-muted mb-4">Click buttons below to test different notification layouts</p>

                        <!-- NotificationManager (Custom In-App) Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">NotificationManager (Custom In-App)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <button class="btn btn-success w-100" onclick="notificationManager.success('Operation completed successfully!')">
                                            <i class="fas fa-check-circle me-2"></i>Success
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-danger w-100" onclick="notificationManager.error('An error occurred. Please try again.')">
                                            <i class="fas fa-exclamation-circle me-2"></i>Error
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-warning w-100" onclick="notificationManager.warning('This action cannot be undone.')">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Warning
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-info w-100" onclick="notificationManager.info('Here is some helpful information.')">
                                            <i class="fas fa-info-circle me-2"></i>Info
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-secondary w-100" onclick="testConfirmDialog()">
                                            <i class="fas fa-question-circle me-2"></i>Confirm Dialog
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-secondary w-100" onclick="notificationManager.clearAll()">
                                            <i class="fas fa-trash me-2"></i>Clear All
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3 mb-0">
                                    <small><strong>Location:</strong> Top-right corner with slide-in animation</small>
                                </div>
                            </div>
                        </div>

                        <!-- Bootstrap Toast Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Bootstrap Toast Notifications</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <button class="btn btn-success w-100" onclick="showBootstrapToast('success', 'Success!', 'Your changes have been saved.')">
                                            <i class="fas fa-check-circle me-2"></i>Success Toast
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-danger w-100" onclick="showBootstrapToast('error', 'Error!', 'Something went wrong.')">
                                            <i class="fas fa-exclamation-circle me-2"></i>Error Toast
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-warning w-100" onclick="showBootstrapToast('warning', 'Warning!', 'Please review your input.')">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Warning Toast
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-info w-100" onclick="showBootstrapToast('info', 'Info', 'Here is some information.')">
                                            <i class="fas fa-info-circle me-2"></i>Info Toast
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3 mb-0">
                                    <small><strong>Location:</strong> Bottom-right corner (Bootstrap default)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Multiple Notifications Section -->
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">Multiple Notifications</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <button class="btn btn-primary w-100" onclick="testMultipleNotifications()">
                                            <i class="fas fa-layer-group me-2"></i>Show 3 Notifications
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-primary w-100" onclick="testLongMessage()">
                                            <i class="fas fa-align-left me-2"></i>Long Message
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-3 mb-0">
                                    <small><strong>Test:</strong> Stack multiple notifications and test with longer messages</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Collection Modal -->
<div class="modal fade" id="addCollectionModal" tabindex="-1" aria-labelledby="addCollectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCollectionModalLabel">Add Collection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCollectionForm">
                    <div class="mb-3">
                        <label for="collectionName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="collectionName" required>
                        <div class="invalid-feedback d-block" id="collectionNameError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="collectionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="collectionDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="collectionContentType" class="form-label">Content Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="collectionContentType">
                            <option value="MANGA">Manga</option>
                            <option value="COMIC">Comic</option>
                            <option value="BOOK">Book</option>
                        </select>
                        <div class="invalid-feedback d-block" id="collectionContentTypeError"></div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="collectionIsDefault">
                        <label class="form-check-label" for="collectionIsDefault">Set as default collection</label>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Setting this collection as default will remove the default status from any previously default collection.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCollectionBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Collection Modal -->
<div class="modal fade" id="editCollectionModal" tabindex="-1" aria-labelledby="editCollectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCollectionModalLabel">Edit Collection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCollectionForm">
                    <input type="hidden" id="editCollectionId">
                    <div class="mb-3">
                        <label for="editCollectionName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCollectionName" required>
                        <div class="invalid-feedback d-block" id="editCollectionNameError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editCollectionDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editCollectionDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editCollectionContentType" class="form-label">Content Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="editCollectionContentType">
                            <option value="MANGA">Manga</option>
                            <option value="COMIC">Comic</option>
                            <option value="BOOK">Book</option>
                        </select>
                        <div class="invalid-feedback d-block" id="editCollectionContentTypeError"></div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editCollectionIsDefault">
                        <label class="form-check-label" for="editCollectionIsDefault">Set as default collection</label>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle"></i> Setting this collection as default will remove the default status from any previously default collection.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateCollectionBtn">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Root Folder Modal -->
<div class="modal fade" id="addRootFolderModal" tabindex="-1" aria-labelledby="addRootFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRootFolderModalLabel">Add Root Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRootFolderForm">
                    <div class="mb-3">
                        <label for="rootFolderPath" class="form-label">Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="rootFolderPath" required>
                            <button class="btn btn-outline-secondary" type="button" id="browseFolderBtn">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="validateFolderBtn" style="display: none;">Validate</button>
                        </div>
                        <small class="form-text text-muted">Enter the full path to the folder containing your manga/comics</small>
                        <input type="file" id="folder-picker" style="display: none;" webkitdirectory directory multiple>
                        <div id="folderValidationStatus" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" id="createFolderBtn" style="display: none;" disabled>
                            <i class="fas fa-folder-plus"></i> Create Folder
                        </button>
                    </div>
                    <div class="mb-3">
                        <label for="rootFolderName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="rootFolderName" required>
                    </div>
                    <div class="mb-3">
                        <label for="rootFolderContentType" class="form-label">Content Type</label>
                        <select class="form-select" id="rootFolderContentType">
                            <option value="MANGA">Manga</option>
                            <option value="COMIC">Comic</option>
                            <option value="BOOK">Book</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRootFolderBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Root Folder Modal -->
<div class="modal fade" id="editRootFolderModal" tabindex="-1" aria-labelledby="editRootFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRootFolderModalLabel">Edit Root Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRootFolderForm">
                    <input type="hidden" id="editRootFolderId">
                    <div class="mb-3">
                        <label for="editRootFolderPath" class="form-label">Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="editRootFolderPath" required>
                            <button class="btn btn-outline-secondary" type="button" id="editBrowseFolderBtn">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="editValidateFolderBtn" style="display: none;">Validate</button>
                        </div>
                        <small class="form-text text-muted">Enter the full path to the folder containing your manga/comics</small>
                        <input type="file" id="edit-folder-picker" style="display: none;" webkitdirectory directory multiple>
                        <div id="editFolderValidationStatus" class="mt-2"></div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary" id="editCreateFolderBtn" style="display: none;" disabled>
                            <i class="fas fa-folder-plus"></i> Create Folder
                        </button>
                    </div>
                    <div class="mb-3">
                        <label for="editRootFolderName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editRootFolderName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRootFolderContentType" class="form-label">Content Type</label>
                        <select class="form-select" id="editRootFolderContentType">
                            <option value="MANGA">Manga</option>
                            <option value="COMIC">Comic</option>
                            <option value="BOOK">Book</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateRootFolderBtn">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Restart Modal -->
<div class="modal fade" id="restartModal" tabindex="-1" aria-labelledby="restartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restartModalLabel">Restart Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Some settings require a restart to take effect. Would you like to restart Readloom now?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
                <button type="button" class="btn btn-primary" id="restart-now-btn">Restart Now</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Load settings
        $.ajax({
            url: '/api/settings',
            method: 'GET',
            success: function(data) {
                // Populate general settings
                $('#host').val(data.host);
                $('#port').val(data.port);
                $('#url-base').val(data.url_base);
                $('#task-interval').val(data.task_interval_minutes);
                $('#metadata-cache').val(data.metadata_cache_days);
                
                // Populate calendar settings
                $('#calendar-range').val(data.calendar_range_days);
                $('#calendar-refresh').val(data.calendar_refresh_hours);
                
                // Populate logging settings
                $('#log-level').val(data.log_level);
                $('#log-rotation').val(data.log_rotation);
                $('#log-size').val(data.log_size);
                
                // Load root folders
                loadRootFolders(data.root_folders);
            },
            error: function(error) {
                console.error('Error loading settings:', error);
                showError('Failed to load settings');
            }
        });
        
        // Load root folders
        function loadRootFolders(rootFolders) {
            const rootFoldersList = $('#root-folders-list');
            rootFoldersList.empty();
            
            if (!rootFolders || rootFolders.length === 0) {
                rootFoldersList.html(
                    '<div class="list-group-item list-group-item-warning">No root folders configured</div>'
                );
                return;
            }
            
            rootFolders.forEach(function(folder, index) {
                const item = $('<div class="list-group-item"></div>');
                const nameElement = $('<h6 class="mb-1"></h6>').text(folder.name);
                const pathElement = $('<p class="mb-1 text-muted"></p>').text(folder.path);
                
                item.append(nameElement);
                item.append(pathElement);
                rootFoldersList.append(item);
            });
        }
        
        // Save general settings
        $('#save-general-settings').click(function() {
            const settings = {
                host: $('#host').val(),
                port: parseInt($('#port').val()),
                url_base: $('#url-base').val(),
                task_interval_minutes: parseInt($('#task-interval').val()),
                metadata_cache_days: parseInt($('#metadata-cache').val())
            };
            
            saveSettings(settings, $(this));
        });
        
        // Save calendar settings
        $('#save-calendar-settings').click(function() {
            const settings = {
                calendar_range_days: parseInt($('#calendar-range').val()),
                calendar_refresh_hours: parseInt($('#calendar-refresh').val())
            };
            
            saveSettings(settings, $(this));
        });
        
        // Save logging settings
        $('#save-logging-settings').click(function() {
            const settings = {
                log_level: $('#log-level').val(),
                log_rotation: parseInt($('#log-rotation').val()),
                log_size: parseInt($('#log-size').val())
            };
            
            saveSettings(settings, $(this));
        });
        
        // Save settings function
        function saveSettings(settings, button) {
            // Validate settings
            for (const key in settings) {
                if (settings[key] === '' || (typeof settings[key] === 'number' && isNaN(settings[key]))) {
                    showWarning(`Invalid value for ${key}`);
                    return;
                }
            }
            
            // Disable button and show loading
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            $.ajax({
                url: '/api/settings',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(settings),
                success: function(response) {
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                    
                    // Show success message
                    showSuccess('Settings saved successfully');
                    
                    // Check if restart is needed
                    if (settings.host !== undefined || settings.port !== undefined || settings.url_base !== undefined) {
                        const restartModal = new bootstrap.Modal(document.getElementById('restartModal'));
                        restartModal.show();
                    }
                },
                error: function(error) {
                    console.error('Error saving settings:', error);
                    showError('Failed to save settings');
                    button.prop('disabled', false).text(originalText);
                }
            });
        }
        
        // Restart button
        $('#restart-now-btn').click(function() {
            // In a real implementation, this would trigger a server restart
            showInfo('Restart functionality will be implemented here');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('restartModal'));
            modal.hide();
        });
    });
</script>
<script src="{{ url_for('static', filename='js/folder-validation.js') }}"></script>
<script src="{{ url_for('static', filename='js/collections_manager.js') }}"></script>
<script>
    $(document).ready(function() {
        // Set up folder validation for the Add Root Folder modal
        setupFolderValidation('rootFolderPath', 'folderValidationStatus', 'validateFolderBtn', 'createFolderBtn');
        
        // Set up folder validation for the Edit Root Folder modal
        setupFolderValidation('editRootFolderPath', 'editFolderValidationStatus', 'editValidateFolderBtn', 'editCreateFolderBtn');
        
        // Generic sync handler function
        function handleReadmeSync(btnId, statusId, endpoint, mergeCheckboxId, successMsg) {
            $(btnId).on('click', function() {
                const $btn = $(this);
                const $status = $(statusId);
                const mergeWithExisting = $(mergeCheckboxId).is(':checked');
                
                // Disable button and show loading state
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Syncing...');
                $status.html('');
                
                // Make API call
                $.ajax({
                    url: endpoint + '?merge=' + (mergeWithExisting ? 'true' : 'false'),
                    method: 'POST',
                    success: function(response) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        if (response.success) {
                            const stats = response.stats;
                            let statusHtml = '<div class="alert alert-success">';
                            statusHtml += '<strong>Sync Complete!</strong><br>';
                            statusHtml += 'Total: ' + stats.total + ' | Synced: ' + stats.synced + ' | Failed: ' + stats.failed;
                            if (stats.errors && stats.errors.length > 0) {
                                statusHtml += '<br><strong>Errors:</strong><ul>';
                                stats.errors.forEach(function(error) {
                                    statusHtml += '<li>' + error + '</li>';
                                });
                                statusHtml += '</ul>';
                            }
                            statusHtml += '</div>';
                            $status.html(statusHtml);
                            showSuccess(successMsg);
                        } else {
                            $status.html('<div class="alert alert-danger">Sync failed: ' + (response.error || 'Unknown error') + '</div>');
                            showError('Sync failed');
                        }
                    },
                    error: function(xhr) {
                        // Reset button
                        $btn.prop('disabled', false).html(originalText);
                        
                        const errorMsg = xhr.responseJSON?.error || 'Sync failed';
                        $status.html('<div class="alert alert-danger">' + errorMsg + '</div>');
                        showError(errorMsg);
                    }
                });
            });
        }
        
        // Author README Sync button handler
        handleReadmeSync('#syncAuthorReadmeBtn', '#authorSyncStatus', '/api/authors/sync-readme', '#authorSyncMerge', 'Author README files synced successfully');
        
        // Book README Sync button handler
        handleReadmeSync('#syncBookReadmeBtn', '#bookSyncStatus', '/api/series/sync-readme', '#bookSyncMerge', 'Book README files synced successfully');
        
        // Manga README Sync button handler
        handleReadmeSync('#syncMangaReadmeBtn', '#mangaSyncStatus', '/api/series/sync-readme-manga', '#mangaSyncMerge', 'Manga README files synced successfully');
        
        // Load Kavita settings
        loadKavitaSettings();
        
        // Kavita Test Connection button
        $('#testKavitaBtn').on('click', function() {
            const url = $('#kavitaUrl').val();
            const username = $('#kavitaUsername').val();
            const password = $('#kavitaPassword').val();
            const $btn = $(this);
            const $status = $('#kavitaStatus');
            
            if (!url || !username || !password) {
                $status.html('<div class="alert alert-warning">Please fill in all fields</div>');
                return;
            }
            
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Testing...');
            $status.html('');
            
            $.ajax({
                url: '/api/integrations/kavita/test',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    url: url,
                    username: username,
                    password: password
                }),
                success: function(response) {
                    $btn.prop('disabled', false).html(originalText);
                    if (response.success) {
                        $status.html('<div class="alert alert-success"><i class="fas fa-check me-2"></i>Connection successful!</div>');
                        showSuccess('Kavita connection test passed');
                    } else {
                        $status.html('<div class="alert alert-danger">' + (response.error || 'Connection failed') + '</div>');
                        showError('Connection test failed');
                    }
                },
                error: function(xhr) {
                    $btn.prop('disabled', false).html(originalText);
                    const errorMsg = xhr.responseJSON?.error || 'Connection test failed';
                    $status.html('<div class="alert alert-danger">' + errorMsg + '</div>');
                    showError(errorMsg);
                }
            });
        });
        
        // Kavita Save Settings button
        $('#saveKavitaBtn').on('click', function() {
            const url = $('#kavitaUrl').val();
            const username = $('#kavitaUsername').val();
            const password = $('#kavitaPassword').val();
            const enabled = $('#kavitaEnabled').is(':checked');
            const $btn = $(this);
            const $status = $('#kavitaStatus');
            
            if (!url || !username || !password) {
                $status.html('<div class="alert alert-warning">Please fill in all fields</div>');
                return;
            }
            
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');
            $status.html('');
            
            $.ajax({
                url: '/api/integrations/kavita/settings',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    url: url,
                    username: username,
                    password: password,
                    enabled: enabled
                }),
                success: function(response) {
                    $btn.prop('disabled', false).html(originalText);
                    if (response.success) {
                        $status.html('<div class="alert alert-success"><i class="fas fa-check me-2"></i>Settings saved successfully!</div>');
                        showSuccess('Kavita settings saved');
                    } else {
                        $status.html('<div class="alert alert-danger">' + (response.error || 'Failed to save settings') + '</div>');
                        showError('Failed to save settings');
                    }
                },
                error: function(xhr) {
                    $btn.prop('disabled', false).html(originalText);
                    const errorMsg = xhr.responseJSON?.error || 'Failed to save settings';
                    $status.html('<div class="alert alert-danger">' + errorMsg + '</div>');
                    showError(errorMsg);
                }
            });
        });
    });
    
    function loadKavitaSettings() {
        $.ajax({
            url: '/api/integrations/kavita/settings',
            method: 'GET',
            success: function(response) {
                if (response.settings) {
                    const settings = response.settings;
                    $('#kavitaUrl').val(settings.url || '');
                    $('#kavitaUsername').val(settings.username || '');
                    $('#kavitaPassword').val(settings.password || '');
                    $('#kavitaEnabled').prop('checked', settings.enabled || false);
                }
            },
            error: function(xhr) {
                // Settings not found, that's okay
                console.log('Kavita settings not found');
            }
        });
    }
    
    // Notification Demo Functions (notificationManager is already initialized globally)
    
    // Test confirm dialog
    window.testConfirmDialog = async function() {
        const result = await notificationManager.confirm('Are you sure you want to proceed?', 
            () => {
                notificationManager.success('You confirmed the action!');
            },
            () => {
                notificationManager.info('You cancelled the action.');
            }
        );
    };
    
    // Bootstrap toast helper
    window.showBootstrapToast = function(type, title, message) {
        let bgClass = 'bg-' + (type === 'error' ? 'danger' : type);
        const toastHtml = `
            <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        toastContainer.appendChild(toastElement.firstElementChild);
        
        const toast = new bootstrap.Toast(toastContainer.lastElementChild);
        toast.show();
    };
    
    // Test multiple notifications
    window.testMultipleNotifications = function() {
        notificationManager.success('First notification - Success!');
        setTimeout(() => {
            notificationManager.warning('Second notification - Warning!');
        }, 500);
        setTimeout(() => {
            notificationManager.info('Third notification - Info');
        }, 1000);
    };
    
    // Test long message
    window.testLongMessage = function() {
        const longMessage = 'This is a longer notification message to test how the notification system handles text wrapping and layout with more content. It should display nicely without breaking the layout.';
        notificationManager.show(longMessage, 'info', 6000);
    };
    
    // Folder browser functionality
    let currentBrowsePath = null;
    let targetInputId = null;
    
    function openFolderBrowser(inputId) {
        targetInputId = inputId;
        currentBrowsePath = null;
        const currentValue = $(`#${inputId}`).val();
        
        if (currentValue) {
            currentBrowsePath = currentValue;
        }
        
        loadFolderBrowserPath(currentBrowsePath);
        bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).show();
    }
    
    function loadFolderBrowserPath(path) {
        $.ajax({
            url: '/api/folders/browse',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ path: path }),
            success: function(response) {
                if (response.success) {
                    currentBrowsePath = response.current_path;
                    $('#folderBrowserCurrentPath').val(currentBrowsePath);
                    $('#folderBrowserSelectedPath').val(currentBrowsePath);
                    
                    if (response.drives && response.drives.length > 0) {
                        $('#folderBrowserDrivesContainer').show();
                        const drivesHtml = response.drives.map(drive => 
                            `<button type="button" class="btn btn-outline-secondary folder-drive-btn" data-path="${drive}">${drive}</button>`
                        ).join('');
                        $('#folderBrowserDrives').html(drivesHtml);
                    } else {
                        $('#folderBrowserDrivesContainer').hide();
                    }
                    
                    if (response.folders && response.folders.length > 0) {
                        const foldersHtml = response.folders.map(folder => 
                            `<div class="list-group-item list-group-item-action cursor-pointer folder-item" data-path="${folder.path}">
                                <i class="fas fa-folder me-2"></i>${folder.name}
                            </div>`
                        ).join('');
                        $('#folderBrowserList').html(foldersHtml);
                    } else {
                        $('#folderBrowserList').html('<div class="text-center text-muted">No folders found</div>');
                    }
                }
            },
            error: function(xhr) {
                console.error('Failed to browse folders');
            }
        });
    }
    
    $('#browseFolderBtn').on('click', function() {
        openFolderBrowser('rootFolderPath');
    });
    
    $('#editBrowseFolderBtn').on('click', function() {
        openFolderBrowser('editRootFolderPath');
    });
    
    $(document).on('click', '.folder-item', function() {
        const path = $(this).data('path');
        loadFolderBrowserPath(path);
    });
    
    $(document).on('click', '.folder-drive-btn', function() {
        const path = $(this).data('path');
        loadFolderBrowserPath(path);
    });
    
    $(document).on('click', '#folderBrowserUpBtn', function() {
        if (currentBrowsePath) {
            const lastBackslash = currentBrowsePath.lastIndexOf('\\');
            const lastForwardSlash = currentBrowsePath.lastIndexOf('/');
            const lastSeparator = Math.max(lastBackslash, lastForwardSlash);
            if (lastSeparator > 0) {
                const parentPath = currentBrowsePath.substring(0, lastSeparator);
                if (parentPath !== currentBrowsePath) {
                    loadFolderBrowserPath(parentPath);
                }
            }
        }
    });
    
    $(document).on('click', '#folderBrowserHomeBtn', function() {
        loadFolderBrowserPath(null);
    });
    
    $(document).on('click', '#folderBrowserSelectBtn', function() {
        if (targetInputId && currentBrowsePath) {
            $(`#${targetInputId}`).val(currentBrowsePath);
            bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).hide();
        }
    });
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>

<!-- Folder Browser Modal -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="folderBrowserModalLabel">Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="folderBrowserCurrentPath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserUpBtn">
                            <i class="fas fa-arrow-up"></i> Up
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserHomeBtn">
                            <i class="fas fa-home"></i> Home
                        </button>
                    </div>
                </div>
                
                <div id="folderBrowserDrivesContainer" class="mb-3" style="display: none;">
                    <label class="form-label">Drives:</label>
                    <div id="folderBrowserDrives" class="btn-group w-100 flex-wrap" role="group"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Folders:</label>
                    <div id="folderBrowserList" class="list-group" style="height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Selected Path:</label>
                    <input type="text" class="form-control" id="folderBrowserSelectedPath" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="folderBrowserSelectBtn">Select</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
