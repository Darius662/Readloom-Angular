{% extends "base.html" %}

{% block title %}Authors - Readloom{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Authors</h2>
                <div>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search authors..." style="width: 300px; display: inline-block;">
                </div>
            </div>
        </div>
    </div>

    <!-- Authors Grid -->
    <div class="row" id="authorsContainer">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading authors...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="paginationContainer">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Author Detail Modal -->
<div class="modal fade" id="authorModal" tabindex="-1" aria-labelledby="authorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorModalLabel">Author Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="authorModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentSearch = '';
const perPage = 12;

$(document).ready(function() {
    loadAuthors();
    
    // Search functionality
    $('#searchInput').on('keyup', function() {
        currentSearch = $(this).val();
        currentPage = 1;
        loadAuthors();
    });
});

function loadAuthors() {
    const url = `/api/authors?page=${currentPage}&per_page=${perPage}` + 
                (currentSearch ? `&search=${encodeURIComponent(currentSearch)}` : '');
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(data) {
            displayAuthors(data.authors);
            displayPagination(data.pagination);
        },
        error: function(error) {
            console.error('Error loading authors:', error);
            $('#authorsContainer').html(
                '<div class="col-12"><div class="alert alert-danger">Failed to load authors</div></div>'
            );
        }
    });
}

function displayAuthors(authors) {
    const container = $('#authorsContainer');
    container.empty();
    
    if (authors.length === 0) {
        container.html('<div class="col-12"><div class="alert alert-info">No authors found</div></div>');
        return;
    }
    
    authors.forEach(author => {
        const birthDate = author.birth_date ? new Date(author.birth_date).getFullYear() : 'Unknown';
        const bio = author.biography ? author.biography.substring(0, 100) + '...' : 'No biography available';
        
        const html = `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 cursor-pointer" onclick="showAuthorDetail(${author.id})">
                    <div class="card-body">
                        <h5 class="card-title">${author.name}</h5>
                        <p class="card-text text-muted small">${bio}</p>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-birthday-cake"></i> ${birthDate}
                            </small>
                        </p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewAuthor(${author.id})">
                            <i class="fas fa-eye me-1"></i> View
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.append(html);
    });
}

function displayPagination(pagination) {
    const container = $('#paginationContainer');
    container.empty();
    
    // Previous button
    if (pagination.page > 1) {
        container.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.page - 1}); return false;">
                    Previous
                </a>
            </li>
        `);
    }
    
    // Page numbers
    for (let i = 1; i <= pagination.pages; i++) {
        const active = i === pagination.page ? 'active' : '';
        container.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="goToPage(${i}); return false;">
                    ${i}
                </a>
            </li>
        `);
    }
    
    // Next button
    if (pagination.page < pagination.pages) {
        container.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.page + 1}); return false;">
                    Next
                </a>
            </li>
        `);
    }
}

function goToPage(page) {
    currentPage = page;
    loadAuthors();
    window.scrollTo(0, 0);
}

function showAuthorDetail(authorId) {
    $.ajax({
        url: `/api/authors/${authorId}`,
        method: 'GET',
        success: function(data) {
            const author = data.author;
            const books = data.books;
            
            let booksHtml = '';
            if (books.length > 0) {
                booksHtml = '<h6 class="mt-3">Books by this author:</h6><ul class="list-group">';
                books.forEach(book => {
                    booksHtml += `
                        <li class="list-group-item">
                            <strong>${book.title}</strong>
                            <br>
                            <small class="text-muted">
                                Type: ${book.content_type} | 
                                Volumes: ${book.volumes}
                            </small>
                        </li>
                    `;
                });
                booksHtml += '</ul>';
            }
            
            const birthDate = author.birth_date ? new Date(author.birth_date).toLocaleDateString() : 'Unknown';
            const deathDate = author.death_date ? new Date(author.death_date).toLocaleDateString() : 'N/A';
            
            const modalBody = `
                <div>
                    <h5>${author.name}</h5>
                    <p><strong>Birth Date:</strong> ${birthDate}</p>
                    <p><strong>Death Date:</strong> ${deathDate}</p>
                    <p><strong>Biography:</strong></p>
                    <p>${author.biography || 'No biography available'}</p>
                    ${booksHtml}
                </div>
            `;
            
            $('#authorModalBody').html(modalBody);
            const modal = new bootstrap.Modal(document.getElementById('authorModal'));
            modal.show();
        },
        error: function(error) {
            console.error('Error loading author details:', error);
            alert('Failed to load author details');
        }
    });
}

function viewAuthor(authorId) {
    window.location.href = `/authors/${authorId}`;
}
</script>

<style>
.cursor-pointer {
    cursor: pointer;
    transition: transform 0.2s;
}

.cursor-pointer:hover {
    /* transform: translateY(-5px); */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
</style>
{% endblock %}
