{% extends "base.html" %}

{% block title %}Search Manga{% endblock %}

{% block content %}
<!-- Content Type Selector -->
<div class="row mb-3">
    <div class="col-12">
        <div class="content-type-selector btn-group w-100">
            <a href="/books/search" 
               class="btn btn-lg btn-outline-primary" id="books-tab">
                <i class="fas fa-book me-1"></i> Books
            </a>
            <a href="/manga/search" 
               class="btn btn-lg btn-primary" id="manga-tab">
                <i class="fas fa-book-open me-1"></i> Manga
            </a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="card-title">Search Manga</h5>
    </div>
    <div class="card-body">
        <form id="mangaSearchForm" class="mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchQuery" placeholder="Enter manga title..." required>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="searchProvider">
                        <option value="">All Providers</option>
                        <!-- Providers will be populated dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i> Search
                    </button>
                </div>
            </div>
        </form>
        
        <div id="searchResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-5 row-cols-xxl-6 g-4">
            <!-- Search results will be populated here -->
        </div>
        
        <div id="loadingIndicator" class="text-center my-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Searching for manga...</p>
        </div>
        
        <div id="noResults" class="text-center my-5 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>No results found</h5>
            <p class="text-muted">Try a different search term or provider</p>
        </div>
    </div>
</div>

<!-- Manga Details Modal -->
<div class="modal fade" id="mangaDetailsModal" tabindex="-1" aria-labelledby="mangaDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mangaDetailsModalLabel">Manga Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <img id="modalCover" src="" alt="Manga Cover" class="img-fluid rounded">
                        <div class="mt-3">
                            <div class="mb-2">
                                <label class="form-label small mb-1">Content Type</label>
                                <select id="modalContentType" class="form-select form-select-sm">
                                    <option value="MANGA">Manga</option>
                                    <option value="MANHWA">Manhwa</option>
                                    <option value="MANHUA">Manhua</option>
                                    <option value="COMIC">Comics</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label small mb-1">Collection</label>
                                <select id="modalCollection" class="form-select form-select-sm">
                                    <!-- Collections will be populated dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small mb-1">Root Folder</label>
                                <select id="modalRootFolder" class="form-select form-select-sm">
                                    <option value="">-- Auto --</option>
                                    <!-- Root folders will be populated dynamically -->
                                </select>
                            </div>
                            <button id="btnAddToCollection" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-plus-circle me-2"></i> Add to Collection
                            </button>
                            <button id="btnWantToRead" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-bookmark me-2"></i> Want to Read
                            </button>
                            <button id="btnViewChapters" class="btn btn-primary w-100">
                                <i class="fas fa-list me-2"></i> View Chapters
                            </button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4 id="modalTitle"></h4>
                        <div id="modalAltTitles" class="text-muted small mb-2"></div>
                        
                        <div class="mb-3">
                            <span class="badge bg-primary me-1" id="modalStatus"></span>
                            <span class="badge bg-info me-1" id="modalSource"></span>
                            <span class="badge bg-warning" id="modalRating"><i class="fas fa-star me-1"></i> <span id="modalRatingValue"></span></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Author:</strong> <span id="modalAuthor"></span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Genres:</strong>
                            <div id="modalGenres" class="mt-1"></div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Description:</strong>
                            <p id="modalDescription" class="mt-1"></p>
                        </div>
                    </div>
                </div>
                
                <div id="chaptersSection" class="mt-4 d-none">
                    <hr>
                    <h5>Chapters</h5>
                    <div id="loadingChapters" class="text-center my-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading chapters...</span>
                    </div>
                    <div id="chaptersList" class="list-group mt-3">
                        <!-- Chapters will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Success Modal -->
<div class="modal fade" id="importSuccessModal" tabindex="-1" aria-labelledby="importSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importSuccessModalLabel">Import Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success fa-4x"></i>
                </div>
                <p id="importSuccessMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="viewSeriesLink" href="#" class="btn btn-primary">View Series</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Load providers
        $.ajax({
            url: '/api/metadata/providers',
            method: 'GET',
            success: function(data) {
                const providerSelect = $('#searchProvider');
                
                if (data.providers) {
                    // Explicitly define manga providers
                    const mangaProviders = [
                        'MangaDex', 'AniList', 'MyAnimeList', 'Comick', 'MangaUpdates',
                        'MangaFire', 'MangaAPI', 'CBRydb', 'WorldCat'
                    ];
                    
                    // Explicitly define book providers
                    const bookProviders = [
                        'GoogleBooks', 'OpenLibrary', 'Goodreads', 'Amazon', 'LibraryThing'
                    ];
                    
                    Object.keys(data.providers).forEach(function(providerName) {
                        const provider = data.providers[providerName];
                        console.log('Provider:', providerName, provider);
                        
                        // Check if this is a manga provider
                        let isMangaProvider = false;
                        
                        // Exact match for known manga providers
                        if (mangaProviders.includes(providerName)) {
                            isMangaProvider = true;
                        }
                        
                        // Check for manga-related keywords in provider name
                        if (providerName.toLowerCase().includes('manga') || 
                            providerName.toLowerCase().includes('anime') || 
                            providerName.toLowerCase().includes('comic')) {
                            isMangaProvider = true;
                        }
                        
                        // Exclude explicitly known book providers
                        if (bookProviders.includes(providerName)) {
                            isMangaProvider = false;
                        }
                        
                        if (provider.enabled && isMangaProvider) {
                            providerSelect.append(`<option value="${providerName}">${providerName}</option>`);
                        }
                    });
                    console.log('Manga providers added to dropdown');
                }
            },
            error: function(xhr) {
                console.error('Error loading providers:', xhr.responseText);
                notificationManager.error('Failed to load metadata providers');
            }
        });
        
        // Search form submission
        $('#mangaSearchForm').on('submit', function(e) {
            e.preventDefault();
            
            const query = $('#searchQuery').val().trim();
            const provider = $('#searchProvider').val();
            
            if (!query) {
                notificationManager.warning('Please enter a search term');
                return;
            }
            
            // Show loading indicator
            $('#searchResults').empty();
            $('#noResults').addClass('d-none');
            $('#loadingIndicator').removeClass('d-none');
            
            // Build URL
            let url = `/api/metadata/search?query=${encodeURIComponent(query)}&content_type=MANGA`;
            if (provider) {
                url += `&provider=${provider}`;
            }
            
            // Perform search
            $.ajax({
                url: url,
                method: 'GET',
                success: function(data) {
                    $('#loadingIndicator').addClass('d-none');
                    
                    let totalResults = 0;
                    const resultsContainer = $('#searchResults');
                    
                    // Process results from each provider
                    if (data.results) {
                        Object.keys(data.results).forEach(function(providerName) {
                            const providerResults = data.results[providerName];
                            
                            if (providerResults && providerResults.length > 0) {
                                totalResults += providerResults.length;
                                
                                providerResults.forEach(function(manga) {
                                    const card = createMangaCard(manga, providerName);
                                    resultsContainer.append(card);
                                });
                            }
                        });
                    }
                    
                    if (totalResults === 0) {
                        $('#noResults').removeClass('d-none');
                    }
                },
                error: function(xhr) {
                    $('#loadingIndicator').addClass('d-none');
                    console.error('Search error:', xhr.responseText);
                    notificationManager.error('Search failed. Please try again.');
                }
            });
        });
        
        // Create manga card
        function createMangaCard(manga, providerName) {
            // Process cover URL - use proxy for external images
            let coverUrl = manga.cover_url || '/static/img/no-cover.png';
            if (coverUrl && coverUrl.startsWith('http')) {
                coverUrl = `/api/proxy/image?url=${encodeURIComponent(coverUrl)}`;
            }
            const title = manga.title || 'Unknown Title';
            const author = manga.author || 'Unknown Author';
            
            return `
                <div class="col">
                    <div class="card h-100">
                        <img src="${coverUrl}" class="card-img-top manga-cover" alt="${title}" onerror="this.src='/static/img/no-cover.png'">
                        <div class="card-body">
                            <h5 class="card-title text-truncate">${title}</h5>
                            <p class="card-text text-muted">${author}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-info">${providerName}</span>
                                ${manga.rating ? `<span class="badge bg-warning"><i class="fas fa-star me-1"></i> ${manga.rating}</span>` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary btn-sm w-100 view-details" 
                                    data-manga-id="${manga.id}" 
                                    data-provider="${providerName}">
                                <i class="fas fa-info-circle me-1"></i> Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Load collections
        function loadCollections() {
            return $.get('/api/collections').then(function(resp) {
                const $sel = $('#modalCollection');
                $sel.empty();
                
                if (resp && resp.success && Array.isArray(resp.collections)) {
                    // Filter for manga collections
                    const mangaCollections = resp.collections.filter(c => 
                        (c.content_type || '').toUpperCase() === 'MANGA' || 
                        (c.content_type || '').toUpperCase() === 'MANHWA' ||
                        (c.content_type || '').toUpperCase() === 'MANHUA' ||
                        (c.content_type || '').toUpperCase() === 'COMIC'
                    );
                    
                    // Sort by name
                    mangaCollections.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Add options
                    mangaCollections.forEach(c => {
                        $sel.append(`<option value="${c.id}">${c.name}${c.is_default? ' (default)':''}</option>`);
                    });
                    
                    // Select default collection
                    const defaultCollection = mangaCollections.find(c => c.is_default === 1);
                    if (defaultCollection) {
                        $sel.val(defaultCollection.id);
                    }
                    
                    // Load root folders for selected collection
                    loadRootFoldersForCollection($sel.val());
                }
            });
        }
        
        // Load root folders for collection
        function loadRootFoldersForCollection(collectionId) {
            const $rf = $('#modalRootFolder');
            $rf.prop('disabled', true).empty().append('<option value="">-- Auto --</option>');
            
            if (!collectionId) return;
            
            $.get(`/api/collections/${collectionId}/root-folders`).then(function(resp) {
                const rootFolders = (resp && resp.success && Array.isArray(resp.root_folders)) ? resp.root_folders : [];
                
                if (rootFolders.length > 0) {
                    rootFolders.forEach(r => $rf.append(`<option value="${r.id}">${r.name} (${r.path})</option>`));
                    $rf.prop('disabled', false);
                }
            });
        }
        
        // Collection change event
        $(document).on('change', '#modalCollection', function() {
            loadRootFoldersForCollection($(this).val());
        });
        
        // Content type change event
        $(document).on('change', '#modalContentType', function() {
            // Auto-select appropriate collection based on content type
            const contentType = $(this).val();
            $.get('/api/collections').then(function(resp) {
                if (resp && resp.success && Array.isArray(resp.collections)) {
                    const defaultCollection = resp.collections.find(c => 
                        c.is_default === 1 && 
                        (c.content_type || '').toUpperCase() === contentType
                    );
                    
                    if (defaultCollection) {
                        $('#modalCollection').val(defaultCollection.id);
                        loadRootFoldersForCollection(defaultCollection.id);
                    }
                }
            });
        });
        
        // View manga details
        $(document).on('click', '.view-details', function() {
            const mangaId = $(this).data('manga-id');
            const provider = $(this).data('provider');
            
            // Reset modal
            $('#modalTitle').text('Loading...');
            $('#modalCover').attr('src', '/static/img/no-cover.png');
            $('#modalAltTitles').empty();
            $('#modalStatus').text('');
            $('#modalSource').text(provider);
            $('#modalRating').addClass('d-none');
            $('#modalAuthor').text('');
            $('#modalGenres').empty();
            $('#modalDescription').text('Loading...');
            $('#chaptersSection').addClass('d-none');
            
            // Store manga ID and provider for add to collection button
            $('#btnAddToCollection').data('manga-id', mangaId);
            $('#btnAddToCollection').data('provider', provider);
            
            // Store manga ID and provider for want to read button
            $('#btnWantToRead').data('manga-id', mangaId);
            $('#btnWantToRead').data('provider', provider);
            
            // Ensure collections are loaded
            loadCollections();
            
            // Show modal
            const mangaModal = new bootstrap.Modal(document.getElementById('mangaDetailsModal'));
            mangaModal.show();
            
            // Fetch manga details
            $.ajax({
                url: `/api/metadata/manga/${provider}/${mangaId}`,
                method: 'GET',
                success: function(data) {
                    // Update modal with manga details
                    $('#modalTitle').text(data.title || 'Unknown Title');
                    
                    // Use image proxy for external images in modal
                    let modalCoverUrl = data.cover_url || '/static/img/no-cover.png';
                    if (modalCoverUrl && modalCoverUrl.startsWith('http')) {
                        modalCoverUrl = `/api/proxy/image?url=${encodeURIComponent(modalCoverUrl)}`;
                    }
                    $('#modalCover').attr('src', modalCoverUrl);
                    
                    // Alternative titles
                    if (data.alternative_titles && data.alternative_titles.length > 0) {
                        $('#modalAltTitles').text('Also known as: ' + data.alternative_titles.join(', '));
                    } else {
                        $('#modalAltTitles').empty();
                    }
                    
                    // Status
                    $('#modalStatus').text(data.status || 'Unknown');
                    
                    // Rating
                    if (data.rating) {
                        $('#modalRating').removeClass('d-none');
                        $('#modalRatingValue').text(data.rating);
                    } else {
                        $('#modalRating').addClass('d-none');
                    }
                    
                    // Author
                    $('#modalAuthor').text(data.author || 'Unknown');
                    
                    // Genres
                    if (data.genres && data.genres.length > 0) {
                        const genresHtml = data.genres.map(genre => 
                            `<span class="badge bg-secondary me-1 mb-1">${genre}</span>`
                        ).join('');
                        $('#modalGenres').html(genresHtml);
                    } else {
                        $('#modalGenres').html('<span class="text-muted">No genres available</span>');
                    }
                    
                    // Description
                    $('#modalDescription').text(data.description || 'No description available');
                    
                    // Set content type
                    if (data.content_type) {
                        $('#modalContentType').val(data.content_type);
                    } else if (provider.includes('Manhwa')) {
                        $('#modalContentType').val('MANHWA');
                    } else if (provider.includes('Manhua')) {
                        $('#modalContentType').val('MANHUA');
                    } else if (provider.includes('Comic')) {
                        $('#modalContentType').val('COMIC');
                    } else {
                        $('#modalContentType').val('MANGA');
                    }
                    
                    // Trigger content type change to auto-select collection
                    $('#modalContentType').trigger('change');
                },
                error: function(xhr) {
                    console.error('Error fetching manga details:', xhr.responseText);
                    $('#modalDescription').text('Error loading manga details');
                }
            });
        });
        
        // View chapters button click
        $('#btnViewChapters').on('click', function() {
            const mangaId = $('#btnAddToCollection').data('manga-id');
            const provider = $('#btnAddToCollection').data('provider');
            
            $('#chaptersSection').removeClass('d-none');
            $('#loadingChapters').removeClass('d-none');
            $('#chaptersList').empty();
            
            // Fetch chapters
            $.ajax({
                url: `/api/metadata/manga/${provider}/${mangaId}/chapters`,
                method: 'GET',
                success: function(data) {
                    $('#loadingChapters').addClass('d-none');
                    
                    if (data.chapters && data.chapters.length > 0) {
                        // Sort chapters by number if possible
                        const chapters = data.chapters.sort((a, b) => {
                            const numA = parseFloat(a.number) || 0;
                            const numB = parseFloat(b.number) || 0;
                            return numB - numA; // Descending order (newest first)
                        });
                        
                        // Add chapters to list
                        chapters.forEach(function(chapter) {
                            const chapterItem = `
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${chapter.title || `Chapter ${chapter.number}`}</h6>
                                        <small>${chapter.date || 'Unknown date'}</small>
                                    </div>
                                    <small class="text-muted">Chapter ${chapter.number}</small>
                                </div>
                            `;
                            $('#chaptersList').append(chapterItem);
                        });
                    } else {
                        $('#chaptersList').html('<div class="alert alert-info">No chapters available</div>');
                    }
                },
                error: function(xhr) {
                    $('#loadingChapters').addClass('d-none');
                    console.error('Error fetching chapters:', xhr.responseText);
                    $('#chaptersList').html('<div class="alert alert-danger">Error loading chapters</div>');
                }
            });
        });
        
        // Add to collection button click
        $('#btnAddToCollection').on('click', function() {
            const mangaId = $(this).data('manga-id');
            const provider = $(this).data('provider');
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Adding...');
            
            // Import manga to collection
            $.ajax({
                url: `/api/metadata/import/${provider}/${mangaId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    content_type: $('#modalContentType').val(),
                    collection_id: $('#modalCollection').val() || null,
                    root_folder_id: $('#modalRootFolder').val() || null,
                }),
                success: function(data) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    // Close details modal
                    bootstrap.Modal.getInstance(document.getElementById('mangaDetailsModal')).hide();
                    
                    if (data.success) {
                        // Show success modal
                        $('#importSuccessMessage').text(data.message);
                        $('#viewSeriesLink').attr('href', `/manga/series/${data.series_id}`);
                        
                        const successModal = new bootstrap.Modal(document.getElementById('importSuccessModal'));
                        successModal.show();
                    } else if (data.already_exists) {
                        // Show already exists notification
                        $('#importSuccessMessage').text('This manga is already in your collection');
                        $('#viewSeriesLink').attr('href', `/manga/series/${data.series_id}`);
                        
                        const successModal = new bootstrap.Modal(document.getElementById('importSuccessModal'));
                        successModal.show();
                    } else {
                        notificationManager.error(data.message || 'Failed to add to collection');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    console.error('Error importing manga:', xhr.responseText);
                    notificationManager.error('Failed to add to collection');
                }
            });
        });
        
        // Want to read button click
        $('#btnWantToRead').on('click', function() {
            const mangaId = $('#btnAddToCollection').data('manga-id');
            const provider = $('#btnAddToCollection').data('provider');
            
            // Disable button and show loading state
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Adding...');
            
            // Add to want to read collection
            $.ajax({
                url: `/api/metadata/want-to-read/${provider}/${mangaId}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    content_type: $('#modalContentType').val(),
                }),
                success: function(data) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    // Close details modal
                    bootstrap.Modal.getInstance(document.getElementById('mangaDetailsModal')).hide();
                    
                    if (data.success) {
                        notificationManager.success('Added to "Want to read"', data.message);
                    } else {
                        notificationManager.error(data.message || 'Failed to add to want to read');
                    }
                },
                error: function(xhr) {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                    
                    console.error('Error adding to want to read:', xhr.responseText);
                    notificationManager.error('Failed to add to want to read');
                }
            });
        });
        
        // Helper function to show toast notifications
        function showToast(type, title, message) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                $('body').append('<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
            }
            
            $('#toastContainer').append(toastHtml);
            const toastElement = $('#toastContainer .toast').last();
            const toast = new bootstrap.Toast(toastElement[0], { autohide: true, delay: 5000 });
            toast.show();
        }
    });
</script>

<style>
    .manga-cover {
        height: 250px;
        object-fit: cover;
    }
    
    #modalCover {
        max-height: 300px;
        object-fit: contain;
    }
    
    #modalDescription {
        max-height: 200px;
        overflow-y: auto;
    }
    
    #chaptersList {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}
