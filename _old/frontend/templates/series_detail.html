{% extends 'base.html' %}

{% block title %}Readloom - Series Detail{% endblock %}

{% block page_title %}Series Detail{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row" id="series-details">
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Move Series Modal -->
<div class="modal fade" id="moveSeriesModal" tabindex="-1" aria-labelledby="moveSeriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveSeriesModalLabel">Move Series</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="move-series-form">
                    <div class="mb-3">
                        <label for="move-target-collection" class="form-label">Target Collection</label>
                        <select class="form-select" id="move-target-collection"></select>
                        <div class="form-text">Only collections in the same bucket as this series are listed.</div>
                    </div>
                    <div class="mb-3">
                        <label for="move-target-root-folder" class="form-label">Target Root Folder (optional)</label>
                        <select class="form-select" id="move-target-root-folder">
                            <option value="">Auto-select first root folder</option>
                        </select>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="move-files-switch">
                        <label class="form-check-label" for="move-files-switch">Physically move files</label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="clear-custom-path-switch">
                        <label class="form-check-label" for="clear-custom-path-switch">Clear custom path after move</label>
                    </div>
                    <div class="border rounded p-2 bg-light">
                        <div class="small text-muted">Dry Run Preview</div>
                        <pre id="move-dryrun-output" class="mb-0" style="white-space: pre-wrap; max-height: 200px; overflow:auto;">No plan yet</pre>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="move-dryrun-btn">Preview (Dry Run)</button>
                <button type="button" class="btn btn-primary" id="move-execute-btn">Execute Move</button>
            </div>
        </div>
    </div>
 </div>

<div class="row mb-4" id="volumes-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Volumes</h5>
                <button class="btn btn-sm btn-primary" id="add-volume-btn">
                    <i class="fas fa-plus"></i> Add Volume
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="volumes-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Release Date</th>
                                <th>Format</th>
                                <th>Digital Format</th>
                                <th>File</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="volumes-list">
                            <tr>
                                <td colspan="7" class="text-center">No volumes found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="chapters-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Chapters</h5>
                <button class="btn btn-sm btn-primary" id="add-chapter-btn">
                    <i class="fas fa-plus"></i> Add Chapter
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="chapters-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Volume</th>
                                <th>Release Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="chapters-list">
                            <tr>
                                <td colspan="6" class="text-center">No chapters found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4" id="upcoming-container" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upcoming Releases</h5>
            </div>
            <div class="card-body">
                <div id="upcoming-events" class="list-group">
                    <div class="text-center py-3">No upcoming releases</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Volume Modal -->
<div class="modal fade" id="volumeModal" tabindex="-1" aria-labelledby="volumeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="volumeModalLabel">Add Volume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="volume-form">
                    <input type="hidden" id="volume-id">
                    <div class="mb-3">
                        <label for="volume-number" class="form-label">Volume Number *</label>
                        <input type="text" class="form-control" id="volume-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="volume-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="volume-title">
                    </div>
                    <div class="mb-3">
                        <label for="volume-description" class="form-label">Description</label>
                        <textarea class="form-control" id="volume-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="volume-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="volume-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="volume-cover-url" class="form-label">Cover URL</label>
                        <input type="url" class="form-control" id="volume-cover-url">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-volume-btn">Save Volume</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Chapter Modal -->
<div class="modal fade" id="chapterModal" tabindex="-1" aria-labelledby="chapterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chapterModalLabel">Add Chapter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="chapter-form">
                    <input type="hidden" id="chapter-id">
                    <div class="mb-3">
                        <label for="chapter-number" class="form-label">Chapter Number *</label>
                        <input type="text" class="form-control" id="chapter-number" required>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="chapter-title">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-volume" class="form-label">Volume</label>
                        <select class="form-select" id="chapter-volume">
                            <option value="">None</option>
                            <!-- Volumes will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-description" class="form-label">Description</label>
                        <textarea class="form-control" id="chapter-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-release-date" class="form-label">Release Date</label>
                        <input type="date" class="form-control" id="chapter-release-date">
                    </div>
                    <div class="mb-3">
                        <label for="chapter-status" class="form-label">Status</label>
                        <select class="form-select" id="chapter-status">
                            <option value="ANNOUNCED">Announced</option>
                            <option value="RELEASED">Released</option>
                            <option value="DELAYED">Delayed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="chapter-read-status" class="form-label">Read Status</label>
                        <select class="form-select" id="chapter-read-status">
                            <option value="UNREAD">Unread</option>
                            <option value="READING">Reading</option>
                            <option value="READ">Read</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-chapter-btn">Save Chapter</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Series Modal -->
<div class="modal fade" id="seriesModal" tabindex="-1" aria-labelledby="seriesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="seriesModalLabel">Edit Series</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="series-form">
                    <div class="mb-3">
                        <label for="series-title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="series-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="series-author" class="form-label">Author</label>
                        <input type="text" class="form-control" id="series-author">
                    </div>
                    <div class="mb-3">
                        <label for="series-publisher" class="form-label">Publisher</label>
                        <input type="text" class="form-control" id="series-publisher">
                    </div>
                    <div class="mb-3">
                        <label for="series-content-type" class="form-label">Content Type</label>
                        <select class="form-select" id="series-content-type">
                            <!-- Content types will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="series-status" class="form-label">Status</label>
                        <select class="form-select" id="series-status">
                            <option value="ONGOING">Ongoing</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="HIATUS">Hiatus</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="UNKNOWN">Unknown</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="series-description" class="form-label">Description</label>
                        <textarea class="form-control" id="series-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="series-cover-url" class="form-label">Cover URL</label>
                        <input type="url" class="form-control" id="series-cover-url">
                    </div>
                    <div class="mb-3">
                        <label for="series-custom-path" class="form-label">Custom Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="series-custom-path" placeholder="/path/to/manga/folder or C:\Path\to\manga\folder">
                            <button class="btn btn-outline-secondary" type="button" id="browse-series-custom-path-btn">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="validate-series-custom-path-btn">Validate</button>
                        </div>
                        <div class="form-text">If your e-books are in a different location than the default, specify the full path here.</div>
                        <div id="series-custom-path-validation-status" class="mt-2"></div>
                        <input type="file" id="series-custom-path-picker" style="display: none;" webkitdirectory directory multiple>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="create-series-custom-path-btn" style="display: none;" disabled>
                                <i class="fas fa-folder-plus"></i> Create Folder
                            </button>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="import-from-custom-path">
                            <label class="form-check-label" for="import-from-custom-path">
                                Import files from custom folder
                            </label>
                            <div class="form-text">When saving, scan this folder for e-books and import them automatically.</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-series-btn">Save Series</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* E-book components styling */
    .ebook-file-container {
        width: 100%;
    }

    /* Move button styling to ensure visibility next to Edit */
    #move-series-btn {
        height: 38px;
        padding: 6px 10px;
        margin: 10px 0;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .ebook-file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px;
        border-radius: 4px;
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .ebook-file-info {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 150px;
    }
    
    .digital-format-selector, .format-selector {
        min-width: 100px;
    }
    
    /* Edit button styling */
    #edit-series-btn {
        width: 38px;
        height: 38px;
        padding: 6px;
        margin: 10px;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    #edit-series-btn i {
        font-size: 16px;
    }
    
    /* Toast styling */
    .toast-container {
        z-index: 9999;
    }
    
    /* Modal styling fixes */
    .modal {
        overflow-y: auto !important;
        z-index: 1050 !important;
    }
    
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    .modal-dialog {
        margin: 1.75rem auto;
        max-width: 600px;
        width: auto;
        z-index: 1055 !important;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        background-color: var(--bs-modal-bg, #fff);
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 0.3rem;
        outline: 0;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    /* Ensure modal elements are clickable */
    .modal-header,
    .modal-body,
    .modal-footer,
    .modal-content button,
    .modal-content input,
    .modal-content .input-group {
        pointer-events: auto !important;
        position: relative;
        z-index: 1060 !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ebook-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/folder-validation.js') }}"></script>
<script>
    $(document).ready(function() {
        const seriesId = "{{ series_id }}";
        let seriesData = null;
        let volumesData = [];
        let chaptersData = [];
        
        // Load series data
        function loadSeriesData() {
            $.ajax({
                url: `/api/series/${seriesId}`,
                method: 'GET',
                success: function(data) {
                    seriesData = data.series;
                    volumesData = data.volumes;
                    chaptersData = data.chapters;
                    // Expose globally for event handlers
                    try { window.currentSeries = seriesData; } catch (e) {}
                    
                    displaySeriesDetails();
                    displayVolumes();
                    displayChapters();
                    displayUpcomingEvents(data.upcoming_events);
                },
                error: function(error) {
                    console.error('Error loading series data:', error);
                    $('#series-details').html('<div class="col-12 text-center text-danger">Failed to load series data</div>');
                }
            });

            // Move button handler (delegated to work with dynamic content)
            $(document).off('click', '#move-series-btn').on('click', '#move-series-btn', function(e) {
                e.preventDefault();
                console.log('Move button clicked');
                const modalEl = document.getElementById('moveSeriesModal');
                let modal = null;
                try {
                    if (window.bootstrap && bootstrap.Modal) {
                        modal = new bootstrap.Modal(modalEl);
                    }
                } catch (err) {
                    console.warn('Bootstrap Modal init failed, will try jQuery .modal("show")', err);
                }
                // Reset preview
                $('#move-dryrun-output').text('No plan yet');
                $('#move-files-switch').prop('checked', false);
                $('#clear-custom-path-switch').prop('checked', false);
                // Use the globally loaded seriesData in this handler
                const series = (typeof window !== 'undefined' && window.currentSeries) ? window.currentSeries : seriesData;
                if (!series || !series.id) {
                    console.error('Series data not ready');
                    if (typeof notificationManager !== 'undefined') { notificationManager.warning('Series data not loaded yet'); }
                    return;
                }

                // Normalize bucket helper
                const normBucket = (t) => {
                    const u = (t || 'MANGA').toString().toUpperCase();
                    if (u === 'COMICS') return 'COMIC';
                    if (u === 'COMIC') return 'COMIC';
                    if (u === 'BOOKS') return 'BOOK';
                    if (u === 'NOVEL' || u === 'NOVELS') return 'BOOK';
                    if (u === 'MANGA' || u === 'MANHWA' || u === 'MANHUA') return 'MANGA';
                    return u;
                };

                const seriesBucket = normBucket(series.content_type);

                // Load target collections and current memberships (dry-run to get before_collections)
                Promise.all([
                    fetch('/api/collections').then(r => r.json()),
                    fetch(`/api/series/${series.id}/move`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ dry_run: true })
                    }).then(r => r.json()).catch(() => ({ result: { before_collections: [] }}))
                ]).then(([payload, moveInfo]) => {
                    const allCols = payload.collections || [];
                    const currentCols = (moveInfo && moveInfo.result && moveInfo.result.before_collections) ? moveInfo.result.before_collections : [];

                    // Filter: same-bucket OR in current memberships (to always show current collection)
                    const allowed = allCols.filter(c => {
                        const b = normBucket(c.content_type);
                        const sameBucket = b === seriesBucket;
                        const isCurrent = currentCols.some(cc => cc.id === c.id);
                        return sameBucket || isCurrent;
                    });

                    const select = $('#move-target-collection');
                    select.empty();
                    if (allowed.length === 0) {
                        select.append('<option value="" disabled>No collections available</option>');
                    } else {
                        allowed.forEach(c => select.append(`<option value="${c.id}">${c.name}</option>`));
                        // Preselect current collection if present
                        const current = currentCols.length ? currentCols[0].id : null;
                        if (current) select.val(String(current));
                    }

                    // Load root folders for selected collection
                    loadRootFoldersForSelectedCollection();
                }).catch(err => {
                    console.error('Failed to init move collections', err);
                });

                // When collection changes, reload root folders
                $('#move-target-collection').off('change').on('change', loadRootFoldersForSelectedCollection);

                function loadRootFoldersForSelectedCollection() {
                    const cid = $('#move-target-collection').val();
                    const rfSelect = $('#move-target-root-folder');
                    rfSelect.empty();
                    rfSelect.append('<option value="">Auto-select first root folder</option>');
                    if (!cid) return;
                    fetch(`/api/collections/${cid}/root-folders`)
                        .then(r => r.json())
                        .then(payload => {
                            (payload.root_folders || []).forEach(rf => rfSelect.append(`<option value="${rf.id}">${rf.name}</option>`));
                        })
                        .catch(err => console.error('Failed to load root folders', err));
                }

                // Dry run
                $('#move-dryrun-btn').off('click').on('click', function() {
                    const body = {
                        target_collection_id: parseInt($('#move-target-collection').val() || '0', 10) || null,
                        target_root_folder_id: parseInt($('#move-target-root-folder').val() || '0', 10) || null,
                        move_files: $('#move-files-switch').is(':checked'),
                        clear_custom_path: $('#clear-custom-path-switch').is(':checked'),
                        dry_run: true
                    };
                    fetch(`/api/series/${series.id}/move`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    })
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.error) {
                            $('#move-dryrun-output').text(`Error: ${resp.error}`);
                            return;
                        }
                        $('#move-dryrun-output').text(JSON.stringify(resp.result, null, 2));
                    })
                    .catch(err => {
                        $('#move-dryrun-output').text(`Error: ${err}`);
                    });
                });

                // Execute move
                $('#move-execute-btn').off('click').on('click', function() {
                    const body = {
                        target_collection_id: parseInt($('#move-target-collection').val() || '0', 10) || null,
                        target_root_folder_id: parseInt($('#move-target-root-folder').val() || '0', 10) || null,
                        move_files: $('#move-files-switch').is(':checked'),
                        clear_custom_path: $('#clear-custom-path-switch').is(':checked'),
                        dry_run: false
                    };
                    fetch(`/api/series/${series.id}/move`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    })
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.error) {
                            notificationManager.error(resp.error);
                            return;
                        }
                        notificationManager.success('Series has been moved successfully.');
                        // Reload series data to reflect changes
                        loadSeriesData();
                        modal.hide();
                    })
                    .catch(err => {
                        notificationManager.error(String(err));
                    });
                });

                try {
                    if (modal && modal.show) {
                        modal.show();
                    } else if (typeof $ !== 'undefined' && $('#moveSeriesModal').modal) {
                        $('#moveSeriesModal').modal('show');
                    } else {
                        console.error('No modal show method available');
                        if (typeof notificationManager !== 'undefined') {
                            notificationManager.error('Unable to open Move dialog');
                        }
                    }
                } catch (err) {
                    console.error('Error showing Move modal', err);
                    if (typeof notificationManager !== 'undefined') {
                        notificationManager.error('Error opening Move dialog');
                    }
                }
            });
        }
        
        // Display series details
        function displaySeriesDetails() {
            const series = seriesData;
            
            const html = `
                <div class="position-relative">
                    <div class="position-absolute top-0 end-0 d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary rounded-circle" id="move-series-btn" title="Move Series" data-bs-toggle="modal" data-bs-target="#moveSeriesModal">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary rounded-circle" id="edit-series-btn" title="Edit Series">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <img src="${processImageUrl(series.cover_url)}" class="img-fluid rounded" alt="${series.title}">
                        </div>
                        <div class="col-md-9">
                            <h2>${series.title}</h2>
                            <p class="text-muted">${series.author ? `Author: ${series.author}` : ''} ${series.publisher ? `| Publisher: ${series.publisher}` : ''}</p>
                            <p>${series.description || 'No description available'}</p>
                            <div class="mb-3">
                                <span class="badge bg-secondary">${series.status || 'Unknown status'}</span>
                                <span class="badge bg-info">${series.content_type || 'MANGA'}</span>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Folder Path: <span id="series-folder-path">Loading...</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#series-details').html(html);
            
            // Fetch folder path
            fetchSeriesFolderPath(series.id, series.title, series.content_type || 'MANGA');
            
            // Set up edit button
            $('#edit-series-btn').click(function() {
                // Load content types
                loadContentTypes().then(() => {
                    // Populate form with series data
                    $('#series-title').val(series.title);
                    $('#series-author').val(series.author || '');
                    $('#series-publisher').val(series.publisher || '');
                    $('#series-status').val(series.status || 'UNKNOWN');
                    $('#series-description').val(series.description || '');
                    $('#series-cover-url').val(series.cover_url || '');
                    $('#series-custom-path').val(series.custom_path || '');
                    
                    // Set content type if available, default to MANGA
                    const contentType = series.content_type || 'MANGA';
                    $('#series-content-type').val(contentType);
                    
                    // Validate the custom path if it exists
                    if (series.custom_path) {
                        // Use the folder validation function
                        validateFolder(series.custom_path, function(result) {
                            if (result.success && result.exists) {
                                // Show validation success message
                                showValidationMessage(document.getElementById('series-custom-path-validation-status'), result.message, 'success');
                                $('#series-custom-path').addClass('is-valid').removeClass('is-invalid');
                                
                                // Show import checkbox if path is valid and exists
                                $('#import-from-custom-path').closest('.form-check').show();
                            } else {
                                // Show validation error message
                                showValidationMessage(document.getElementById('series-custom-path-validation-status'), result.message, 'danger');
                                $('#series-custom-path').addClass('is-invalid').removeClass('is-valid');
                                
                                // Hide import checkbox if path is invalid or doesn't exist
                                $('#import-from-custom-path').prop('checked', false).closest('.form-check').hide();
                                
                                // Show create button if folder doesn't exist
                                if (!result.exists) {
                                    $('#create-series-custom-path-btn').prop('disabled', false).show();
                                }
                            }
                        });
                    } else {
                        // Hide import checkbox if no custom path
                        $('#import-from-custom-path').prop('checked', false).closest('.form-check').hide();
                    }
                    
                    // Show the modal
                    const seriesModal = new bootstrap.Modal(document.getElementById('seriesModal'));
                    seriesModal.show();
                });
            });
            
            // Function to fetch series folder path
            function fetchSeriesFolderPath(seriesId, seriesTitle, contentType) {
                // Create a temporary object to create the path
                const data = {
                    action: 'get_folder_path',
                    series_id: seriesId,
                    title: seriesTitle,
                    content_type: contentType
                };
                
                fetch('/api/series/folder-path', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error fetching folder path:', data.error);
                        $('#series-folder-path').text('Error fetching path');
                        $('#folder-path-info').text('Error fetching path');
                    } else {
                        const folderPath = data.folder_path;
                        $('#series-folder-path').text(folderPath);
                        $('#folder-path-info').text(folderPath);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    $('#series-folder-path').text('Error fetching path');
                    $('#folder-path-info').text('Error fetching path');
                });
            }
            
            // Function to load content types
            function loadContentTypes() {
                return fetch('/api/ebooks/content-types')
                    .then(response => response.json())
                    .then(data => {
                        const contentTypeSelect = $('#series-content-type');
                        contentTypeSelect.empty();
                        
                        // Add content type options
                        data.content_types.forEach(contentType => {
                            contentTypeSelect.append(`<option value="${contentType.id}">${contentType.name}</option>`);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading content types:', error);
                    });
            }
        }
        
        // Display volumes
        function displayVolumes() {
            if (volumesData.length > 0) {
                let html = '';
                
                // Fetch collection items for this series
                fetch(`/api/collection?series_id=${seriesId}&item_type=VOLUME`)
                    .then(response => response.json())
                    .then(collectionData => {
                        const collectionItems = collectionData.items || [];
                        
                        // Fetch e-book files for this series
                        fetch(`/api/ebooks/series/${seriesId}`)
                            .then(response => response.json())
                            .then(ebookData => {
                                const ebookFiles = ebookData.files || [];
                                
                                volumesData.forEach(volume => {
                                    // Find collection item for this volume
                                    const collectionItem = collectionItems.find(item => item.volume_id === volume.id);
                                    
                                    // Find e-book file for this volume
                                    const ebookFile = ebookFiles.find(file => file.volume_id === volume.id);
                                    
                                    // Default values if no collection item exists
                                    let format = 'NONE';
                                    let digitalFormat = 'NONE';
                                    let hasFile = 0;
                                    
                                    if (collectionItem) {
                                        format = collectionItem.format || 'NONE';
                                        digitalFormat = collectionItem.digital_format || 'NONE';
                                        hasFile = collectionItem.has_file || 0;
                                    }
                                    
                                    // Format select options
                                    const formatOptions = [
                                        { value: 'PHYSICAL', label: 'Physical' },
                                        { value: 'DIGITAL', label: 'Digital' },
                                        { value: 'BOTH', label: 'Both' },
                                        { value: 'NONE', label: 'None' }
                                    ];
                                    
                                    let formatSelect = `<select class="form-select form-select-sm format-selector" data-volume-id="${volume.id}" data-series-id="${seriesId}">`;
                                    formatOptions.forEach(option => {
                                        formatSelect += `<option value="${option.value}"${format === option.value ? ' selected' : ''}>${option.label}</option>`;
                                    });
                                    formatSelect += '</select>';
                                    
                                    // Digital format select options
                                    const digitalFormatOptions = [
                                        { value: 'PDF', label: 'PDF' },
                                        { value: 'EPUB', label: 'EPUB' },
                                        { value: 'CBZ', label: 'CBZ' },
                                        { value: 'CBR', label: 'CBR' },
                                        { value: 'MOBI', label: 'MOBI' },
                                        { value: 'AZW', label: 'AZW' },
                                        { value: 'Individual Images', label: 'Individual Images' },
                                        { value: 'NONE', label: 'None' }
                                    ];
                                    
                                    let digitalFormatSelect = `<select class="form-select form-select-sm digital-format-selector" data-volume-id="${volume.id}" data-series-id="${seriesId}"${format !== 'DIGITAL' && format !== 'BOTH' ? ' style="display: none;"' : ''}>`;
                                    digitalFormatOptions.forEach(option => {
                                        digitalFormatSelect += `<option value="${option.value}"${digitalFormat === option.value ? ' selected' : ''}>${option.label}</option>`;
                                    });
                                    digitalFormatSelect += '</select>';
                                    
                                    // File upload/display component
                                    let fileComponent = '';
                                    
                                    if (ebookFile) {
                                        fileComponent = `
                                            <div class="ebook-file-container" data-volume-id="${volume.id}">
                                                <div class="ebook-file-item" data-file-id="${ebookFile.id}">
                                                    <span class="ebook-file-info">${ebookFile.original_name || ebookFile.file_name}</span>
                                                    <div class="btn-group btn-group-sm ms-2">
                                                        <a href="/api/ebooks/${ebookFile.id}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        <button class="btn btn-sm btn-outline-danger delete-ebook" data-file-id="${ebookFile.id}" data-volume-id="${volume.id}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        fileComponent = `
                                            <div class="ebook-file-container" data-volume-id="${volume.id}">
                                                <div class="input-group input-group-sm">
                                                    <input type="file" class="form-control ebook-upload" data-volume-id="${volume.id}" data-series-id="${seriesId}" style="display: none;">
                                                    <button class="btn btn-sm btn-outline-primary ebook-upload-button" data-volume-id="${volume.id}"${format !== 'DIGITAL' && format !== 'BOTH' ? ' style="display: none;"' : ''}>
                                                        <i class="fas fa-upload"></i> Upload File
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    html += `
                                        <tr>
                                            <td>${volume.volume_number}</td>
                                            <td>${volume.title || '-'}</td>
                                            <td>${volume.release_date || '-'}</td>
                                            <td>${formatSelect}</td>
                                            <td>${digitalFormatSelect}</td>
                                            <td>${fileComponent}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary edit-volume" data-id="${volume.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger delete-volume" data-id="${volume.id}" data-number="${volume.volume_number}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                });
                                
                                $('#volumes-list').html(html);
                                $('#volumes-container').show();
                                
                                // Set up edit buttons
                                $('.edit-volume').click(function() {
                                    const volumeId = $(this).data('id');
                                    editVolume(volumeId);
                                });
                                
                                // Set up delete buttons
                                $('.delete-volume').click(function() {
                                    const volumeId = $(this).data('id');
                                    const volumeNumber = $(this).data('number');
                                    
                                    $('#delete-message').text(`Are you sure you want to delete Volume ${volumeNumber}?`);
                                    $('#confirm-delete-btn').data('type', 'volume').data('id', volumeId);
                                    
                                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                                    deleteModal.show();
                                });
                                
                                // Initialize format selectors
                                $('.format-selector').change(function() {
                                    const volumeId = $(this).data('volume-id');
                                    const format = $(this).val();
                                    
                                    if (format === 'DIGITAL' || format === 'BOTH') {
                                        $(`.digital-format-selector[data-volume-id="${volumeId}"]`).show();
                                        $(`.ebook-upload-button[data-volume-id="${volumeId}"]`).show();
                                    } else {
                                        $(`.digital-format-selector[data-volume-id="${volumeId}"]`).hide();
                                        $(`.ebook-upload-button[data-volume-id="${volumeId}"]`).hide();
                                    }
                                });
                                
                                // Initialize digital format selectors
                                $('.digital-format-selector').change(function() {
                                    const volumeId = $(this).data('volume-id');
                                    const digitalFormat = $(this).val();
                                    
                                    fetch(`/api/collection/volume/${volumeId}/digital-format`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            digital_format: digitalFormat
                                        })
                                    });
                                });
                                
                                // Initialize file upload buttons
                                $('.ebook-upload-button').click(function() {
                                    const volumeId = $(this).data('volume-id');
                                    $(`.ebook-upload[data-volume-id="${volumeId}"]`).click();
                                });
                                
                                // Initialize the ebook manager
                                if (window.ebookManager) {
                                    window.ebookManager.initFormatSelectors();
                                    window.ebookManager.initFileUploads();
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching e-book files:', error);
                                $('#volumes-list').html('<tr><td colspan="7" class="text-center">Error loading volumes</td></tr>');
                            });
                    })
                    .catch(error => {
                        console.error('Error fetching collection items:', error);
                        $('#volumes-list').html('<tr><td colspan="7" class="text-center">Error loading volumes</td></tr>');
                    });
            } else {
                $('#volumes-list').html('<tr><td colspan="7" class="text-center">No volumes found</td></tr>');
                $('#volumes-container').show();
            }
        }
        
        // Display chapters
        function displayChapters() {
            if (chaptersData.length > 0) {
                let html = '';
                
                chaptersData.forEach(chapter => {
                    // Find volume if it exists
                    let volumeNumber = '-';
                    if (chapter.volume_id) {
                        const volume = volumesData.find(v => v.id === chapter.volume_id);
                        if (volume) {
                            volumeNumber = volume.volume_number;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${chapter.chapter_number}</td>
                            <td>${chapter.title || '-'}</td>
                            <td>${volumeNumber}</td>
                            <td>${chapter.release_date || '-'}</td>
                            <td><span class="badge bg-${getStatusBadgeClass(chapter.status)}">${chapter.status || 'Unknown'}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-chapter" data-id="${chapter.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger delete-chapter" data-id="${chapter.id}" data-number="${chapter.chapter_number}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                $('#chapters-list').html(html);
                $('#chapters-container').show();
                
                // Set up edit buttons
                $('.edit-chapter').click(function() {
                    const chapterId = $(this).data('id');
                    editChapter(chapterId);
                });
                
                // Set up delete buttons
                $('.delete-chapter').click(function() {
                    const chapterId = $(this).data('id');
                    const chapterNumber = $(this).data('number');
                    
                    $('#delete-message').text(`Are you sure you want to delete Chapter ${chapterNumber}?`);
                    $('#confirm-delete-btn').data('type', 'chapter').data('id', chapterId);
                    
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();
                });
            } else {
                $('#chapters-list').html('<tr><td colspan="6" class="text-center">No chapters found</td></tr>');
                $('#chapters-container').show();
            }
        }
        
        // Display upcoming events
        function displayUpcomingEvents(events) {
            if (events && events.length > 0) {
                let html = '';
                
                events.forEach(event => {
                    const eventDate = new Date(event.date);
                    const formattedDate = eventDate.toLocaleDateString();
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${event.title}</h6>
                                <small>${formattedDate}</small>
                            </div>
                            <small>${event.description}</small>
                        </div>
                    `;
                });
                
                $('#upcoming-events').html(html);
                $('#upcoming-container').show();
            } else {
                $('#upcoming-events').html('<div class="text-center py-3">No upcoming releases</div>');
                $('#upcoming-container').show();
            }
        }
        
        // Get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'RELEASED':
                    return 'success';
                case 'ANNOUNCED':
                    return 'info';
                case 'DELAYED':
                    return 'warning';
                case 'CANCELLED':
                    return 'danger';
                default:
                    return 'secondary';
            }
        }
        
        // Add volume
        $('#add-volume-btn').click(function() {
            // Reset form
            $('#volume-form')[0].reset();
            $('#volume-id').val('');
            $('#volumeModalLabel').text('Add Volume');
            
            const modal = new bootstrap.Modal(document.getElementById('volumeModal'));
            modal.show();
        });
        
        // Edit volume
        function editVolume(volumeId) {
            const volume = volumesData.find(v => v.id === volumeId);
            
            if (volume) {
                $('#volume-id').val(volume.id);
                $('#volume-number').val(volume.volume_number);
                $('#volume-title').val(volume.title);
                $('#volume-description').val(volume.description);
                $('#volume-release-date').val(volume.release_date);
                $('#volume-cover-url').val(volume.cover_url);
                
                $('#volumeModalLabel').text('Edit Volume');
                
                const modal = new bootstrap.Modal(document.getElementById('volumeModal'));
                modal.show();
            }
        }
        
        // Save volume
        $('#save-volume-btn').click(function() {
            const volumeNumber = $('#volume-number').val();
            
            if (!volumeNumber) {
                alert('Volume number is required');
                return;
            }
            
            const volumeData = {
                volume_number: volumeNumber,
                title: $('#volume-title').val(),
                description: $('#volume-description').val(),
                release_date: $('#volume-release-date').val(),
                cover_url: $('#volume-cover-url').val()
            };
            
            const volumeId = $('#volume-id').val();
            let url = `/api/series/${seriesId}/volumes`;
            let method = 'POST';
            
            if (volumeId) {
                url = `/api/volumes/${volumeId}`;
                method = 'PUT';
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(volumeData),
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('volumeModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error saving volume:', error);
                    alert('Failed to save volume');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Add chapter
        $('#add-chapter-btn').click(function() {
            // Reset form
            $('#chapter-form')[0].reset();
            $('#chapter-id').val('');
            $('#chapterModalLabel').text('Add Chapter');
            
            // Populate volumes dropdown
            populateVolumesDropdown();
            
            const modal = new bootstrap.Modal(document.getElementById('chapterModal'));
            modal.show();
        });
        
        // Edit chapter
        function editChapter(chapterId) {
            const chapter = chaptersData.find(c => c.id === chapterId);
            
            if (chapter) {
                // Populate volumes dropdown
                populateVolumesDropdown();
                
                $('#chapter-id').val(chapter.id);
                $('#chapter-number').val(chapter.chapter_number);
                $('#chapter-title').val(chapter.title);
                $('#chapter-volume').val(chapter.volume_id || '');
                $('#chapter-description').val(chapter.description);
                $('#chapter-release-date').val(chapter.release_date);
                $('#chapter-status').val(chapter.status);
                $('#chapter-read-status').val(chapter.read_status);
                
                $('#chapterModalLabel').text('Edit Chapter');
                
                const modal = new bootstrap.Modal(document.getElementById('chapterModal'));
                modal.show();
            }
        }
        
        // Populate volumes dropdown
        function populateVolumesDropdown() {
            let options = '<option value="">None</option>';
            
            volumesData.forEach(volume => {
                options += `<option value="${volume.id}">Volume ${volume.volume_number}</option>`;
            });
            
            $('#chapter-volume').html(options);
        }
        
        // Save chapter
        $('#save-chapter-btn').click(function() {
            const chapterNumber = $('#chapter-number').val();
            
            if (!chapterNumber) {
                alert('Chapter number is required');
                return;
            }
            
            const chapterData = {
                chapter_number: chapterNumber,
                title: $('#chapter-title').val(),
                volume_id: $('#chapter-volume').val() || null,
                description: $('#chapter-description').val(),
                release_date: $('#chapter-release-date').val(),
                status: $('#chapter-status').val(),
                read_status: $('#chapter-read-status').val()
            };
            
            const chapterId = $('#chapter-id').val();
            let url = `/api/series/${seriesId}/chapters`;
            let method = 'POST';
            
            if (chapterId) {
                url = `/api/chapters/${chapterId}`;
                method = 'PUT';
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(chapterData),
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('chapterModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error saving chapter:', error);
                    alert('Failed to save chapter');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Delete confirmation
        $('#confirm-delete-btn').click(function() {
            const type = $(this).data('type');
            const id = $(this).data('id');
            
            let url;
            if (type === 'volume') {
                url = `/api/volumes/${id}`;
            } else if (type === 'chapter') {
                url = `/api/chapters/${id}`;
            } else {
                return;
            }
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
            
            $.ajax({
                url: url,
                method: 'DELETE',
                success: function() {
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();
                    
                    // Reload series data
                    loadSeriesData();
                    
                    // Reset button
                    button.prop('disabled', false).text(originalText);
                },
                error: function(error) {
                    console.error('Error deleting item:', error);
                    alert('Failed to delete item');
                    button.prop('disabled', false).text(originalText);
                }
            });
        });
        
        // Save series
        $('#save-series-btn').click(function() {
            const seriesTitle = $('#series-title').val();
            
            if (!seriesTitle) {
                alert('Series title is required');
                return;
            }
            
            const seriesData = {
                title: seriesTitle,
                author: $('#series-author').val(),
                publisher: $('#series-publisher').val(),
                status: $('#series-status').val(),
                description: $('#series-description').val(),
                cover_url: $('#series-cover-url').val(),
                content_type: $('#series-content-type').val(),
                custom_path: $('#series-custom-path').val()
            };
            
            // Disable button and show loading
            const button = $(this);
            const originalText = button.text();
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            
            // Update series
            fetch(`/api/series/${seriesId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(seriesData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error updating series:', data.error);
                    alert('Failed to update series: ' + data.error);
                    button.prop('disabled', false).text(originalText);
                } else {
                    // Check if we need to import files from custom path
                    const importFromCustomPath = $('#import-from-custom-path').is(':checked');
                    const customPath = $('#series-custom-path').val().trim();
                    
                    if (importFromCustomPath && customPath) {
                        // Show scanning message
                        button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scanning for files...');
                        
                        // Prepare request data for scanning
                        const requestData = {
                            series_id: seriesId,
                            custom_path: customPath
                        };
                        
                        // Scan for e-books in the custom path
                        fetch('/api/ebooks/scan', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        })
                        .then(response => response.json())
                        .then(scanData => {
                            // Hide modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('seriesModal'));
                            modal.hide();
                            
                            // Reload series data
                            loadSeriesData();
                            
                            // Show success message with scan results
                            if (scanData.error) {
                                notificationManager.warning('Series updated but file scan failed: ' + scanData.error);
                            } else {
                                const stats = scanData.stats || {};
                                const added = stats.added || 0;
                                notificationManager.success(`Series updated and ${added} files imported successfully`);
                            }
                            
                            // Reset button
                            button.prop('disabled', false).text(originalText);
                        })
                        .catch(error => {
                            console.error('Error scanning for files:', error);
                            
                            // Hide modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('seriesModal'));
                            modal.hide();
                            
                            // Reload series data
                            loadSeriesData();
                            
                            // Show mixed message
                            notificationManager.warning('Series updated but file scan failed');
                            
                            // Reset button
                            button.prop('disabled', false).text(originalText);
                        });
                    } else {
                        // Hide modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('seriesModal'));
                        modal.hide();
                        
                        // Reload series data
                        loadSeriesData();
                        
                        // Show success message
                        notificationManager.success('Series updated successfully');
                        
                        // Reset button
                        button.prop('disabled', false).text(originalText);
                    }
                }
            })
            .catch(error => {
                console.error('Error updating series:', error);
                alert('Failed to update series');
            })
            .finally(() => {
                // Reset button
                button.prop('disabled', false).text(originalText);
            });
        });
        
        // Add scan button to the page
        $('#series-details').after(`
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">E-book Management</h5>
                            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#ebookManagementCollapse" aria-expanded="false" aria-controls="ebookManagementCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="collapse" id="ebookManagementCollapse">
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Folder Location</h6>
                                    <p class="text-muted">Place your e-book files in this folder: <span id="folder-path-info" class="font-monospace">Loading...</span></p>
                                    <p class="small">Supported file formats: PDF, EPUB, CBZ, CBR, MOBI, AZW</p>
                                    <p class="small">Naming examples: "Volume 1.pdf", "Vol 2.epub", "v3.cbz", "4.pdf"</p>
                                    
                                    <div class="mt-3">
                                        <p class="small">To set a custom path for this series, use the <strong>Edit Series</strong> button above.</p>
                                    </div>
                                </div>
                                <hr>
                                <p>Scan your data directory for e-books and automatically add them to the database.</p>
                                <button class="btn btn-primary" id="scan-ebooks-btn">
                                    <i class="fas fa-search"></i> Scan for E-books
                                </button>
                                <div id="scan-results" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted small">Quick Actions</span>
                                <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" id="quick-move-series-btn" title="Move Series" data-bs-toggle="modal" data-bs-target="#moveSeriesModal">
                                    <i class="fas fa-exchange-alt"></i> Move
                                </button>
                                <button class="btn btn-sm btn-primary" id="quick-scan-ebooks-btn">
                                    <i class="fas fa-search"></i> Scan for E-books
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        // Set up toggle button icon change
        $('#ebookManagementCollapse').on('show.bs.collapse', function () {
            $(this).closest('.card').find('.card-header button i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
        });
        
        $('#ebookManagementCollapse').on('hide.bs.collapse', function () {
            $(this).closest('.card').find('.card-header button i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
        });
        
        // Set up scan button
        function scanEbooks(button) {
            // Store original button text and state
            const originalText = button.text();
            const originalHtml = button.html();
            
            // Disable button and show loading
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scanning...');
            
            // Prepare request data
            const requestData = {
                series_id: seriesId
            };
            
            // Scan for e-books for this specific series
            fetch('/api/ebooks/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error scanning for e-books:', data.error);
                    $('#scan-results').html(`<div class="alert alert-danger">Error: ${data.error}</div>`).show();
                    // Show the details panel if using quick scan
                    if (button.attr('id') === 'quick-scan-ebooks-btn') {
                        $('#ebookManagementCollapse').collapse('show');
                    }
                } else {
                    // Get stats from response, ensure all values are defined
                    const stats = data.stats || {};
                    const scanned = stats.scanned || 0;
                    const added = stats.added || 0;
                    const skipped = stats.skipped || 0;
                    
                    // Show results
                    $('#scan-results').html(`
                        <div class="alert alert-success">
                            <strong>Scan completed!</strong><br>
                            Files scanned: ${scanned}<br>
                            Files added: ${added}<br>
                            Files skipped: ${skipped}
                        </div>
                    `).show();
                    
                    // Show the details panel if using quick scan and files were added
                    if (button.attr('id') === 'quick-scan-ebooks-btn' && added > 0) {
                        $('#ebookManagementCollapse').collapse('show');
                    }
                    
                    // If files were added, reload volumes data
                    if (added > 0) {
                        loadSeriesData();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#scan-results').html(`<div class="alert alert-danger">Error: ${error.message || 'Unknown error'}</div>`).show();
                // Show the details panel if using quick scan
                if (button.attr('id') === 'quick-scan-ebooks-btn') {
                    $('#ebookManagementCollapse').collapse('show');
                }
            })
            .finally(() => {
                // Reset button
                button.prop('disabled', false).html(originalHtml);
            });
        }
        
        // Set up main scan button
        $('#scan-ebooks-btn').click(function() {
            scanEbooks($(this));
        });
        
        // Set up quick scan button
        $('#quick-scan-ebooks-btn').click(function() {
            scanEbooks($(this));
        });

        // Quick move button uses same handler as header button
        $(document).off('click', '#quick-move-series-btn').on('click', '#quick-move-series-btn', function(e) {
            e.preventDefault();
            $('#move-series-btn').trigger('click');
        });
        
        // Initial load
        loadSeriesData();
        
        // Set up folder validation for the custom path
        setupFolderValidation('custom-path', 'custom-path-validation-status', 'validate-custom-path-btn', 'create-custom-path-btn');
        
        // Set up folder validation for the series custom path in the Edit Series modal
        setupFolderValidation('series-custom-path', 'series-custom-path-validation-status', 'validate-series-custom-path-btn', 'create-series-custom-path-btn');
        
        // Add custom handler for series custom path validation
        $('#validate-series-custom-path-btn').click(function() {
            const customPath = $('#series-custom-path').val().trim();
            if (customPath) {
                validateFolder(customPath, function(result) {
                    if (result.success && result.exists) {
                        // Show import checkbox if path is valid and exists
                        $('#import-from-custom-path').closest('.form-check').show();
                    } else {
                        // Hide import checkbox if path is invalid or doesn't exist
                        $('#import-from-custom-path').prop('checked', false).closest('.form-check').hide();
                    }
                });
            } else {
                // Hide import checkbox if no path is entered
                $('#import-from-custom-path').prop('checked', false).closest('.form-check').hide();
            }
        });
        
        // Initially hide the import checkbox
        $('#import-from-custom-path').closest('.form-check').hide();
        
        // Hide import checkbox when custom path changes
        $('#series-custom-path').on('input', function() {
            $('#import-from-custom-path').prop('checked', false).closest('.form-check').hide();
        });
        
        // Folder browser functionality
        let currentBrowsePath = null;
        let targetInputId = null;
        
        function openFolderBrowser(inputId) {
            targetInputId = inputId;
            currentBrowsePath = null;
            const currentValue = $(`#${inputId}`).val();
            
            if (currentValue) {
                currentBrowsePath = currentValue;
            }
            
            loadFolderBrowserPath(currentBrowsePath);
            bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).show();
        }
        
        function loadFolderBrowserPath(path) {
            $.ajax({
                url: '/api/folders/browse',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ path: path }),
                success: function(response) {
                    if (response.success) {
                        currentBrowsePath = response.current_path;
                        $('#folderBrowserCurrentPath').val(currentBrowsePath);
                        $('#folderBrowserSelectedPath').val(currentBrowsePath);
                        
                        if (response.drives && response.drives.length > 0) {
                            $('#folderBrowserDrivesContainer').show();
                            const drivesHtml = response.drives.map(drive => 
                                `<button type="button" class="btn btn-outline-secondary folder-drive-btn" data-path="${drive}">${drive}</button>`
                            ).join('');
                            $('#folderBrowserDrives').html(drivesHtml);
                        } else {
                            $('#folderBrowserDrivesContainer').hide();
                        }
                        
                        if (response.folders && response.folders.length > 0) {
                            const foldersHtml = response.folders.map(folder => 
                                `<div class="list-group-item list-group-item-action cursor-pointer folder-item" data-path="${folder.path}">
                                    <i class="fas fa-folder me-2"></i>${folder.name}
                                </div>`
                            ).join('');
                            $('#folderBrowserList').html(foldersHtml);
                        } else {
                            $('#folderBrowserList').html('<div class="text-center text-muted">No folders found</div>');
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Failed to browse folders');
                }
            });
        }
        
        $('#browse-series-custom-path-btn').on('click', function() {
            openFolderBrowser('series-custom-path');
        });
        
        $(document).on('click', '.folder-item', function() {
            const path = $(this).data('path');
            loadFolderBrowserPath(path);
        });
        
        $(document).on('click', '.folder-drive-btn', function() {
            const path = $(this).data('path');
            loadFolderBrowserPath(path);
        });
        
        $(document).on('click', '#folderBrowserUpBtn', function() {
            if (currentBrowsePath) {
                const lastBackslash = currentBrowsePath.lastIndexOf('\\');
                const lastForwardSlash = currentBrowsePath.lastIndexOf('/');
                const lastSeparator = Math.max(lastBackslash, lastForwardSlash);
                if (lastSeparator > 0) {
                    const parentPath = currentBrowsePath.substring(0, lastSeparator);
                    if (parentPath !== currentBrowsePath) {
                        loadFolderBrowserPath(parentPath);
                    }
                }
            }
        });
        
        $(document).on('click', '#folderBrowserHomeBtn', function() {
            loadFolderBrowserPath(null);
        });
        
        $(document).on('click', '#folderBrowserSelectBtn', function() {
            if (targetInputId && currentBrowsePath) {
                $(`#${targetInputId}`).val(currentBrowsePath);
                bootstrap.Modal.getOrCreateInstance(document.getElementById('folderBrowserModal')).hide();
            }
        });
    });
</script>

<!-- Folder Browser Modal -->
<div class="modal fade" id="folderBrowserModal" tabindex="-1" aria-labelledby="folderBrowserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="folderBrowserModalLabel">Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="folderBrowserCurrentPath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserUpBtn">
                            <i class="fas fa-arrow-up"></i> Up
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="folderBrowserHomeBtn">
                            <i class="fas fa-home"></i> Home
                        </button>
                    </div>
                </div>
                
                <div id="folderBrowserDrivesContainer" class="mb-3" style="display: none;">
                    <label class="form-label">Drives:</label>
                    <div id="folderBrowserDrives" class="btn-group w-100 flex-wrap" role="group"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Folders:</label>
                    <div id="folderBrowserList" class="list-group" style="height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Selected Path:</label>
                    <input type="text" class="form-control" id="folderBrowserSelectedPath" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="folderBrowserSelectBtn">Select</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
